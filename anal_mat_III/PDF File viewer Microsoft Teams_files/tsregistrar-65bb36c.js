!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define("@skype/tsregistrar",[],e):"object"==typeof exports?exports["@skype/tsregistrar"]=e():t["@skype/tsregistrar"]=e()}(this,function(){return function(t){function e(n){if(r[n])return r[n].exports;var i=r[n]={i:n,l:!1,exports:{}};return t[n].call(i.exports,i,i.exports,e),i.l=!0,i.exports}var r={};return e.m=t,e.c=r,e.i=function(t){return t},e.d=function(t,r,n){e.o(t,r)||Object.defineProperty(t,r,{configurable:!1,enumerable:!0,get:n})},e.n=function(t){var r=t&&t.__esModule?function(){return t.default}:function(){return t};return e.d(r,"a",r),r},e.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},e.p="",e(e.s=1)}([function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.fetchWithTimeout=function(t,e){var r,n=new Promise(function(e,n){fetch(t).then(function(t){clearTimeout(r),e(t)}).catch(function(t){clearTimeout(r),n(t)})});if(0!==e){var i=new Promise(function(n,i){r=setTimeout(i,e,new Error("Fetch for '"+t.url+"' timed out"))});return Promise.race([n,i])}return n},e.toJson=function(t){try{return JSON.stringify(t)}catch(e){return"Unable to serialize object of type "+typeof t}};var n=function(){function t(){this.start=Date.now()}return Object.defineProperty(t.prototype,"duration",{get:function(){return Date.now()-this.start},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"startTime",{get:function(){return this.start},enumerable:!0,configurable:!0}),t.prototype.reset=function(){this.start=Date.now()},t}();e.Timespan=n},function(t,e,r){"use strict";var n=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])};return function(e,r){function n(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}(),i=this&&this.__awaiter||function(t,e,r,n){return new(r||(r=Promise))(function(i,o){function s(t){try{c(n.next(t))}catch(t){o(t)}}function a(t){try{c(n.throw(t))}catch(t){o(t)}}function c(t){t.done?i(t.value):new r(function(e){e(t.value)}).then(s,a)}c((n=n.apply(t,e||[])).next())})},o=this&&this.__generator||function(t,e){function r(t){return function(e){return n([t,e])}}function n(r){if(i)throw new TypeError("Generator is already executing.");for(;c;)try{if(i=1,o&&(s=2&r[0]?o.return:r[0]?o.throw||((s=o.return)&&s.call(o),0):o.next)&&!(s=s.call(o,r[1])).done)return s;switch(o=0,s&&(r=[2&r[0],s.value]),r[0]){case 0:case 1:s=r;break;case 4:return c.label++,{value:r[1],done:!1};case 5:c.label++,o=r[1],r=[0];continue;case 7:r=c.ops.pop(),c.trys.pop();continue;default:if(s=c.trys,!(s=s.length>0&&s[s.length-1])&&(6===r[0]||2===r[0])){c=0;continue}if(3===r[0]&&(!s||r[1]>s[0]&&r[1]<s[3])){c.label=r[1];break}if(6===r[0]&&c.label<s[1]){c.label=s[1],s=r;break}if(s&&c.label<s[2]){c.label=s[2],c.ops.push(r);break}s[2]&&c.ops.pop(),c.trys.pop();continue}r=e.call(t,c)}catch(t){r=[6,t],o=0}finally{i=s=0}if(5&r[0])throw r[1];return{value:r[0]?r[1]:void 0,done:!0}}var i,o,s,a,c={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return a={next:r(0),throw:r(1),return:r(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a};Object.defineProperty(e,"__esModule",{value:!0});var s=r(0),a=function(t){function e(e){var r=t.call(this,e)||this;return r.name="CancelationError",r}return n(e,t),e}(Error),c=function(){function t(e,r,n){this.logger=e,this.maxBackoffInMs=r,this.initialDelay=n,this.backoffCount=0,this.id=++t.idCounter}return t.prototype.delay=function(t){var e=this;if(void 0!==this.timerHandle)throw new Error("Retry sequence logical failure");if(-1===this.backoffCount)return new Promise(function(t,e){e(new a("Cancelled"))});var r=this.calculateNextBackoffMs();return this.backoffCount++,this.logger.info("[RegistrarClient] Backing off "+t+" for "+r+" milliseconds with ID "+this.id),new Promise(function(n,i){e.cancelFunc=i,e.timerHandle=setTimeout(function(){e.logger.info("[RegistrarClient] Back off for "+t+" with ID "+e.id+" complete"),e.timerHandle=void 0,n()},r)})},t.prototype.cancel=function(){void 0!==this.timerHandle&&(this.logger.debug("Resetting back off"),clearTimeout(this.timerHandle),void 0!==this.cancelFunc&&this.cancelFunc(new a("Cancelled"))),this.backoffCount=-1},t.prototype.calculateNextBackoffMs=function(){var t=1+.4*(Math.random()-.5),e=this.initialDelay*Math.pow(2,this.backoffCount)*t;return e=Math.round(e),Math.min(this.maxBackoffInMs,e)},t.idCounter=0,t}(),u=function(){function t(t,e,r){this.logger=t,this.skypeTokenProvider=e,this.options=r,this.DEFAULT_MAX_RETRIES_FOR_GET_TOKEN=15,this.DEFAULT_MAX_BACKOFF_TIME_IN_MS=3e5,this.backoffs={},this.maxBackOffTime=this.options.maxRetryDelayMs>0?this.options.maxRetryDelayMs:this.DEFAULT_MAX_BACKOFF_TIME_IN_MS,this.maxRetriesForGetToken=void 0===r.maxRetriesForGetToken||null===r.maxRetriesForGetToken?this.DEFAULT_MAX_RETRIES_FOR_GET_TOKEN:r.maxRetriesForGetToken}return t.prototype.setTelemetryLogger=function(t){this.eventLogger=t},t.prototype.register=function(t,e){return i(this,void 0,void 0,function(){return o(this,function(r){switch(r.label){case 0:return[4,this.performRegistration(t,e,"pr_set_registration")];case 1:return r.sent(),this.cachedRegistrationParams=[t,e],[2]}})})},t.prototype.unregister=function(){return i(this,void 0,void 0,function(){var t;return o(this,function(e){switch(e.label){case 0:return this.logger.info("[RegistrarClient] sending unregister request"),t=new Request(this.options.registrarUrl+"/"+this.options.registrationId,{method:"DELETE",mode:"cors",headers:new Headers({accept:"application/json, text/javascript"})}),[4,this.callRegistrar(t,"pr_delete_registration")];case 1:return e.sent(),[2]}})})},t.prototype.cancelPendingRequests=function(){var t=this;Object.keys(this.backoffs).forEach(function(e){t.backoffs[e].cancel()}),this.backoffs={}},t.prototype.resendRegistration=function(){return i(this,void 0,void 0,function(){return o(this,function(t){switch(t.label){case 0:if(!this.cachedRegistrationParams)throw new Error("Re-registration failed because there is no registration parameters cached");return[4,this.performRegistration(this.cachedRegistrationParams[0],this.cachedRegistrationParams[1],"pr_resend_registration")];case 1:return t.sent(),[2]}})})},t.prototype.performRegistration=function(t,e,r){return i(this,void 0,void 0,function(){var n,i;return o(this,function(o){switch(o.label){case 0:return this.logger.info("[RegistrarClient] Sending register request"),n={clientDescription:t,registrationId:this.options.registrationId,nodeId:"",transports:e},i=new Request(this.options.registrarUrl,{method:"POST",mode:"cors",headers:new Headers({"content-type":"application/json",accept:"application/json, text/javascript"}),body:s.toJson(n)}),[4,this.callRegistrar(i,r)];case 1:return o.sent(),[2]}})})},t.prototype.startBackoff=function(){var t=new c(this.logger,this.maxBackOffTime,this.options.initialRetryDelayMs);return this.backoffs[t.id]=t,t},t.prototype.stopBackoff=function(t){t.cancel(),delete this.backoffs[t.id]},t.prototype.getSkypeToken=function(){return i(this,void 0,void 0,function(){var t,e,r,n,i,s,a;return o(this,function(o){switch(o.label){case 0:t=this.startBackoff(),e=0,o.label=1;case 1:return o.trys.push([1,3,,8]),this.logger.info("[RegistrarClient] Asking for a new skypetoken"),[4,this.skypeTokenProvider(!0)];case 2:return r=o.sent(),this.stopBackoff(t),[2,r];case 3:n=o.sent(),o.label=4;case 4:return o.trys.push([4,6,,7]),e++,i=JSON.stringify(n),e>this.maxRetriesForGetToken?(s="[RegistrarClient] getSkypeToken retry limit hit. Will not retry now. Error: "+i,this.logger.error(s),this.stopBackoff(t),[2,Promise.reject(s)]):(this.logger.warn("[RegistrarClient] Retrying for a new skype token. Retry Count: "+e+" Error: "+i),[4,t.delay("Fetching a new skypetoken")]);case 5:return o.sent(),[3,8];case 6:throw a=o.sent(),this.stopBackoff(t),a;case 7:return[3,8];case 8:return[3,1];case 9:return[2]}})})},t.prototype.callRegistrar=function(t,e){return i(this,void 0,void 0,function(){var r,n,i,a,c,u,l,f,h,p,d,g,y,k,m,v;return o(this,function(o){switch(o.label){case 0:return r=this.startBackoff(),[4,this.skypeTokenProvider(!1)];case 1:n=o.sent(),this.setSkypeTokenHeader(t,n),i=new s.Timespan,a=0,o.label=2;case 2:c=void 0,o.label=3;case 3:return o.trys.push([3,8,13,14]),u=t.clone(),[4,s.fetchWithTimeout(u,this.options.requestTimeoutMs)];case 4:return 401!==(c=o.sent()).status?[3,6]:++a>this.maxRetriesForGetToken?(l="[RegistrarClient] getSkypeToken retry limit hit. Will not retry now. Request '"+t.url+"' failed with "+c.status+" "+c.statusText,this.logger.error(l),this.stopBackoff(r),[2,Promise.reject(l)]):(this.logger.warn("[RegistrarClient] Retry Count "+a+". Request '"+t.url+"' failed with "+c.status+" "+c.statusText),f=this.setSkypeTokenHeader,h=[t],[4,this.getSkypeToken()]);case 5:return f.apply(this,h.concat([o.sent()])),[3,20];case 6:if(c.status>=500&&c.status<600)throw new Error("Fetch for '"+t.url+"' failed with "+c.status+" "+c.statusText);o.label=7;case 7:return[3,14];case 8:p=o.sent(),this.logger.error("[RegistrarClient] Request failed with "+p),o.label=9;case 9:return o.trys.push([9,11,,12]),[4,r.delay("Registrar call retry")];case 10:return o.sent(),[3,20];case 11:throw d=o.sent(),this.logger.error("[RegistrarClient] Request cancelled"),this.stopBackoff(r),d;case 12:return[3,14];case 13:return this.sendTelemetryEvent(e,t,c,i),[7];case 14:return this.stopBackoff(r),c.ok?[2,c]:[3,15];case 15:g=void 0,o.label=16;case 16:return o.trys.push([16,18,,19]),k=(y=JSON).stringify,[4,c.json()];case 17:return g=k.apply(y,[o.sent()]),[3,19];case 18:return m=o.sent(),g="no details",[3,19];case 19:throw v="Fetch for '"+t.url+"' failed with "+c.status+" "+c.statusText+" ("+g+", MS-CV: "+c.headers.get("MS-CV")+")",this.logger.error("[RegistrarClient] "+v),new Error(v);case 20:return[3,2];case 21:return[2]}})})},t.prototype.setSkypeTokenHeader=function(t,e){t.headers.set("X-Skypetoken",e)},t.prototype.sendTelemetryEvent=function(t,e,r,n){if(void 0!==this.eventLogger){var i={name:t,properties:{url:{value:e.url},result_code:{value:void 0!==r?r.status:0},begin_timestamp:{value:n.startTime},elapsed:{value:n.duration}}};this.eventLogger.logEvent(i)}},t}();e.RegistrarClient=u,e.createRegistrarClient=function(t,e,r){return new u(t,e,r)}}])});
//# sourceMappingURL=[[staticsPath]]/hashed/tsregistrar-3c759b0.js.map