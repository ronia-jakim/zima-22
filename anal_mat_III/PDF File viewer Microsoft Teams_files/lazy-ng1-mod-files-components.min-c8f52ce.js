webpackJsonp([21],{2744:function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),i(2745),i(2749),i(2751),i(2754),i(2756)},2745:function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var s=i(2746),r=i(2747),n=i(2748),o=function(){function e(e,t,i,s,r,n,o,a,l,c,d,h,p,f,u,v,m,g){var y=this;if(this.$q=i,this.constants=s,this.layoutService=r,this.utilityService=o,this.loggingService=a,this.messageService=l,this.filesMessagePaneHelper=c,this.authenticationService=d,this.filesEntityService=h,this.storageService=f,this.filesUtilityService=u,this.channelService=v,this.settingsService=m,this.contextPaneInitialized=!1,this.showStartConversationButton=!1,this.panelRegions=teamspace.PanelRegion,this.moreOptionsText=e.instant(n.strings.files_moreOptions),this.theme=m.getActiveTheme(),g.$on(t,s.events.layout.themeChanged,function(){y.theme=m.getActiveTheme()}),this.provider){if(this.provider.iconsService){var w=this.provider.iconsService.getIcon(this.fileType);w&&(this.fileIconPath=w.largeIconPath||w.defaultIconPath,this.isSvgIcon=w.isSvg,this.iconAltTextKey=w.altTextResourceKey)}p.getEntryBreadcrumbInfo(this.provider).then(function(e){y.thumbnailImgSrc=e.thumbnailImgSrc})}this.fileIconPath||(this.fileIconPath=this.getTypeSvgSrc(),this.isSvgIcon=!0),t.$on("$destroy",function(){c&&c.destroyContextMessagePane()})}return e.$inject=["$translate","$scope","$q","constants","layoutService","resources","utilityService","loggingService","messageService","filesMessagePaneHelper","authenticationService","filesEntityService","filesNavigationEntryService","storageService","filesUtilityService","channelService","settingsService","eventingService"],e.prototype.$onChanges=function(e){if(this.hasPrimaryOptions=this.primaryOptions&&this.primaryOptions.options&&this.primaryOptions.options.length&&this.primaryOptions.options.some(function(e){return!e.shouldBeHidden()}),this.settingsService.valueAsBoolean(this.constants.settings.names.enableTeamArchive)&&this.conversationInfo&&this.conversationInfo.threadId){var t=this.channelService.getParentTeamAndChannelByChannelId(this.conversationInfo.threadId);this.isTeamArchived=t&&t.team&&t.team.isArchived}this.isEditButtonAvailable=!!this.hasPrimaryOptions||this.filesUtilityService.isVisioDesktopAppOnlyEditEnabled(this.fileType)||this.moveEditInBrowserFromMoreOptions,this.hasMoreOptions=this.moreOptions&&this.moreOptions.length&&this.moreOptions.some(function(e){return!e.shouldBeHidden()}),e.error&&e.error.previousValue!==e.error.currentValue&&void 0!==e.error.currentValue&&this.initConversation(),e.displayTitleBar&&!1===e.displayTitleBar.previousValue&&!0===e.displayTitleBar.currentValue&&this.initConversation()},e.prototype.getChatButtonVisibity=function(){return!!this._conversationInfo&&(/p2p/i.test(this._conversationInfo.serviceName)||this.channelService.canPostToChannel(this.conversationInfo.threadId))},e.prototype.initConversation=function(){var e=this.$q.defer();if(this.filesMessagePaneHelper&&this._conversationInfo&&this._conversationInfo.threadId&&this.viewerType&&void 0!=this.displayTitleBar){var t=this.displayTitleBar||void 0!==this.error,i=/p2p/i.test(this._conversationInfo.serviceName);return this.filesMessagePaneHelper.initializeContextMessagePane(this._conversationInfo.objectId,this._conversationInfo.threadId,this.viewerType,i,void 0,t)}return e.promise},Object.defineProperty(e.prototype,"conversationInfo",{get:function(){return this._conversationInfo},set:function(e){this._conversationInfo||(this._conversationInfo=e)},enumerable:!0,configurable:!0}),e.prototype.getTypeSvgSrc=function(){void 0===this.fileType&&(this.loggingService.warn("[getTypeSvgSrc] FileType is undefined, setting to empty string to get default svg"),this.fileType="");var e=this.utilityService.getIconClass({type:this.fileType}),t=this.constants.css.fileIcons;return[t.excel,t.onenote,t.pdf,t.powerpoint,t.visio,t.word].includes(e)?"svg/"+this.utilityService.getSVGBase(this.fileType,"icons-{type}-file-32_1.5x")+".html":"svg/"+this.utilityService.getSVGBase(this.fileType,"icons-{type}")+".html"},e.prototype.startOrShowConversation=function(){var e=this;if(this.contextPaneInitialized)this.rightRailShowExistingComponent();else{var t=this.loggingService.newScenario(this.constants.scenarios.files.toggleChatOpened);this.filesMessagePaneHelper.getReplyChainIdFromFileId(this._conversationInfo.objectId,this._conversationInfo.threadId).then(function(i){i?(e.storageService.set(""+e.constants.files.strings.saveChatIsExpanded,!0),e.initConversation().then(function(t){e.contextPaneInitialized=!0,t&&e.filesMessagePaneHelper.showRightRail(e._conversationInfo.threadId,i,teamspace.services.ReplyChainIdType.ParentMessageId,/p2p/i.test(e._conversationInfo.serviceName))}).catch(function(i){e.loggingService.error("startOrShowConversation: failed to initialize context with error  "+i),t.fail({errorMessage:"Failed to start conversation"})}),t.stop()):(e.createFileAttachment?e.createFileAttachment():e.filesEntityService.getFileDetail(e.fileType,e.conversationInfo.objectUrl).then(function(e){return e.value}).then(function(t){return e.getAttachment(t)})).then(function(t){var i=e.getMessageParams(t,e.conversationInfo.threadId);return e.messageService.createMessage(i)}).then(function(t){return e.authenticationService.getUserInformation().then(function(e){return{upn:((e||{}).profile||{}).upn,messageId:t.messageId}})}).then(function(t){return t.upn?e.storageService.set(""+e.constants.files.strings.saveChatIsExpanded,!0):e.loggingService.warn("Failed to resolve user upn on start conversation"),t.messageId?e.storageService.set(""+e.constants.files.strings.saveChatIsExpanded,!0):e.loggingService.warn("Failed to resolve messageId on start conversation"),t.messageId}).then(function(t){return e.filesMessagePaneHelper.initializeContextMessagePane(e.conversationInfo.objectId,e.conversationInfo.threadId,e.viewerType,!1,t)}).then(function(){return t.stop()}).catch(function(i){var s="Failed to start conversation";e.loggingService.error(s),t.fail({error:s})})})}},e.prototype.rightRailShowExistingComponent=function(){var e=this.loggingService.newScenario(this.constants.scenarios.files.toggleChatOpened);this.layoutService.rightRailShowExistingComponent(),e.stop()},e.prototype.getAttachment=function(e){return{objectId:e.objectId,objectUrl:e.objectUrl,siteUrl:e.siteUrl,serverRelativeUrl:e.serverRelativeUrl,title:e.title,type:e.type}},e.prototype.getMessageParams=function(e,t){return{conversationId:t,replyChainId:"",messageSubject:"",messageBody:"",messagePreview:"",fileAttachments:[e],extensions:"",mentions:"",embeddedLinks:[],isHtml:!0,importance:null,clientId:SkypeX.Services.Utilities.newClientMessageId(),draftObjectId:""}},e}();angular.module("teamspace.fileDocumentTitleBar",["teamspace.layoutService","teamspace.utilityService","teamspace.loggingService","teamspace.messageService","teamspace.settingsService","teamspace.filesEntityService","teamspace.authenticationService","teamspace.filesMessagePaneHelper"]).component("fileDocumentTitleBar",{bindings:{isEditMode:"<?",displayTitleBar:"<?",editAction:"<?",fileName:"<",fileType:"<",fileId:"<",viewerType:"<",hideClose:"<?",onClose:"&?",isEnabled:"=",inlineActions:"<?",primaryOptions:"<?",moreOptions:"<?",conversationInfo:"<?",createFileAttachment:"&?",provider:"<?",error:"<?",errorReasonForTelemetry:"<?",moveEditInBrowserFromMoreOptions:"<?"},template:s,controller:o}).run(["$templateCache",function(e){e.put("components/files/document-viewer/file-document-title-bar/file-document-title-bar-options.html",r),e.put("components/files/document-viewer/file-document-title-bar/file-document-title-bar-more-options.html",n)}])},2746:function(e,t){e.exports='<div class="app-title-bar">\n  <svg-include class="title-component title-visible svg-icon" ng-if="$ctrl.isSvgIcon" src="::$ctrl.fileIconPath"></svg-include>\n  <div class="title-component title-visible img-icon" ng-if="!$ctrl.isSvgIcon">\n    <img ng-src="{{::$ctrl.fileIconPath}}" alt="{{::$ctrl.iconAltTextKey|translate}}" title="{{::$ctrl.iconAltTextKey|translate}}"/>\n  </div>\n  <h1 class="title-component title-visible" data-tid="document-stage-title-bar">\n    <span class="document-title" tabindex="0" role="heading">{{::$ctrl.fileName}}</span>\n  </h1>\n  \x3c!--\n    TODO: Requirement 437506\n      <span class="save-status" id="file-save-status"></span>\n  --\x3e\n</div>\n<div class="right-side-buttons pull-right">\n  <div ng-if="::$ctrl.thumbnailImgSrc" class="provider-icon">\n    <span class="app-svg img-container">\n      <img ng-src="{{::$ctrl.thumbnailImgSrc}}"/>\n    </span>\n  </div>\n  <div ng-if="$ctrl.inlineActions && $ctrl.inlineActions.length">\n    <button class="ts-sym inline-action" type="button" ng-repeat="menuItem in $ctrl.inlineActions track by $index" ng-if="!(menuItem.shouldBeHidden && menuItem.shouldBeHidden())" ng-click="menuItem.click()" ng-disabled="!$ctrl.isEnabled" aria-label="{{menuItem.title || menuItem.displayName || undefined}}" ng-attr-title="{{menuItem.title || undefined}}">\n      <svg-include src="menuItem.svgPath"></svg-include>\n      <span>{{menuItem.displayName}}</span>\n    </button>\n  </div>\n  <div class="btn-edit btn-group" ng-if="$ctrl.isEditButtonAvailable && !$ctrl.isEditMode && $ctrl.editAction">\n      <button class="btn ts-btn ts-btn-fluent ts-btn-fluent-titlebar" ng-class="($ctrl.theme==\'contrast\') ? \'ts-btn-fluent-secondary\' : \'ts-btn-fluent-primary\'" aria-label="{{::$ctrl.primaryOptions.primaryButtonAria}}" type="button" ng-click="$ctrl.editAction()" ng-disabled="!$ctrl.isEnabled || $ctrl.isTeamArchived" data-tid="title-bar-primary-edit-button">\n        <span class="ts-btn-edit-text">{{::$ctrl.primaryOptions.primaryButtonText}}</span>\n      </button>\n      <div ng-if="::$ctrl.hasPrimaryOptions" class="dropdown-separator"></div>\n      <button ng-if="::$ctrl.hasPrimaryOptions" aria-label="{{::$ctrl.primaryOptions.dropdownButtonText}}" class="btn ts-btn ts-btn-fluent tn-btn-titlebar inset-border dropdown-toggle-split" ng-class="($ctrl.theme==\'contrast\') ? \'ts-btn-fluent-secondary\' : \'ts-btn-fluent-primary\'" ng-disabled="!$ctrl.isEnabled || $ctrl.isTeamArchived" bs-dropdown placement="bottom" container="body" data-template-url="components/files/document-viewer/file-document-title-bar/file-document-title-bar-options.html" data-tid="title-bar-dropdown-edit-button">\n        <svg-include src="\'svg/icons-triangle-down-small.html\'"></svg-include>\n      </button>\n  </div>\n    <button class="ts-btn ts-btn-fluent ts-btn-fluent-titlebar" ng-class="($ctrl.theme==\'contrast\') ? \'ts-btn-fluent-secondary\' : \'ts-btn-fluent-primary\'" ng-if="::$ctrl.hasPrimaryOptions && !$ctrl.editAction" type="button" ng-disabled="!$ctrl.isEnabled" bs-dropdown placement="bottom" container="body" data-template-url="components/files/document-viewer/file-document-title-bar/file-document-title-bar-options.html" data-tid="title-bar-edit-button">\n      <span class="ts-btn-edit-text">{{::$ctrl.primaryOptions.primaryButtonText}}</span>\n      <ng-include src="\'svg/icons-triangle-down-small.html\'"></ng-include>\n    </button>\n    <button ng-show="$ctrl.showStartConversationButton" class="ts-btn ts-btn-fluent ts-btn-fluent-secondary ts-btn-fluent-titlebar" type="button" ng-click="$ctrl.startConversation()" translate-once="{{::$root.resources.strings.files_startConversation }}" track-outcome="{{::$root.trackConstants.trackOutcome.submit}}" track-scenario="{{::$root.trackConstants.trackScenario.fileStartConversation}}" track-scenario-type="{{::$root.trackConstants.trackScenarioType.files}}" track-name="{{::$root.trackConstants.trackModuleName.documentStageStartConversationButton}}" track-type="{{::$root.trackConstants.trackType.submit}}" track-summary="Starts a conversation around the file and opens the chat pane" data-tid="start-conversation" ng-disabled="!$ctrl.isEnabled">\n    </button>\n    <button class="ts-btn ts-btn-fluent ts-btn-fluent-secondary btn-close ts-btn-fluent-titlebar" ng-if="$ctrl.onClose && !$ctrl.hideClose" type="button" ng-click="$ctrl.onClose()" track-outcome="{{::$root.trackConstants.trackOutcome.nav}}" track-outcome-new="{{::$root.trackConstants.trackOutcome.submit}}" track-scenario="{{::$root.trackConstants.trackScenario.closeDocumentStage}}" track-scenario-type="{{::$root.trackConstants.trackScenarioType.files}}" track-name="{{::$root.trackConstants.trackModuleName.documentStageCloseButton}}" track-work-load="{{::$root.trackConstants.trackWorkLoad.files}}" track-sub-work-load="{{::$root.trackConstants.trackSubWorkLoad.closeFile}}" track-name-new="{{::$root.trackConstants.trackModuleName.fileClose}}" track-type="{{::$root.trackConstants.trackType.other}}" track-type-new="{{::$root.trackConstants.trackType.fileEditorTopButton}}" track-summary="Close the document stage" aria-label="{{::$root.resources.strings.files_closeDocumentStageAria | translate }}" translate-once="{{::$root.resources.strings.files_closeFullscreenButton }}" data-tid="fullscreen-close-button">\n    </button>\n</div>\n<span ng-if="!$ctrl.hasMoreOptions" class="right-padding"></span>\n<div ng-if="$ctrl.hasMoreOptions" class="inline-button pull-right">\n  <button class="ts-sym app-icons-fill-hover" title="{{::$ctrl.moreOptionsText}}" aria-label="{{::$ctrl.moreOptionsText}}" type="button" ng-disabled="!$ctrl.isEnabled" bs-dropdown placement="bottom" container="body" data-template-url="components/files/document-viewer/file-document-title-bar/file-document-title-bar-more-options.html" data-tid="title-bar-more-button" aria-haspopup="true">\n    <ng-include src="\'svg/icons-more.html\'"></ng-include>\n  </button>\n</div>\n<div class="inline-button pull-right collapsable" ng-class="{\'expand\': $ctrl.layoutService.rightRailVisible}">\n  <button ng-disabled="!$ctrl.isEnabled" type="button" ng-if="!$ctrl.layoutService.rightRailVisible && $ctrl.displayTitleBar && $ctrl.getChatButtonVisibity()" class="ts-sym app-icons-fill-hover pull-right" ng-click="$ctrl.startOrShowConversation()" track-outcome="{{::$root.trackConstants.trackOutcome.submit}}" track-scenario="{{::$root.trackConstants.trackScenario.fileStartConversation}}" track-scenario-type="{{::$root.trackConstants.trackScenarioType.files}}" track-name="{{::$root.trackConstants.trackModuleName.documentStageStartConversationButton}}" track-type="{{::$root.trackConstants.trackType.submit}}" track-summary="Opens the conversation around the file" data-tid="document-chat-expand" title="{{::$root.resources.strings.calling_toggleChat_on|translate}}" aria-label="{{::$root.resources.strings.calling_toggleChat_on|translate}}">\n    <ng-include src="\'svg/icons-chat.html\'"></ng-include>\n  </button>\n</div>\n'},2747:function(e,t){e.exports='<div class="context-dropdown dropdown-menu dropdown app-default-menu files-popover">\n  <ul class="context-menu-dropdown file-action-menu" acc-role="menu">\n    <li ng-repeat="menuItem in $ctrl.primaryOptions.options track by $index" ng-class="::menuItem.class" ng-if="!(menuItem.shouldBeHidden && menuItem.shouldBeHidden())" class="ts-menu-item" acc-role="menu-item focus-default" aria-label="{{ ::menuItem.displayName }}">\n      <button class="ts-sym ts-svg" acc-role="focus-default" ng-click="menuItem.click()" data-tid="{{ menuItem.id }}" type="button" track-outcome="{{::$root.trackConstants.trackOutcome.submit}}" track-scenario="{{menuItem.id == \'office-open-in-desktop-app\' ? $root.trackConstants.trackScenario.editFileInApp : $root.trackConstants.trackScenario.editFileOnline}}" track-scenario-type="{{::$root.trackConstants.trackScenarioType.files}}" track-name="{{::$root.trackConstants.trackModuleName.fileDocumentTitleBar}}" track-type="{{::$root.trackConstants.trackType.menuItem}}" track-data="{fileAction: \'{{::menuItem.id}}\', fileControl: \'file edit menu\', fileId: \'{{::$ctrl.fileId}}\'}" track-summary="Edit a file in app OR edit a file in Office online">\n        <ng-include src="menuItem.svgPath"></ng-include>\n        <span aria-hidden="true">{{menuItem.displayName}}</span>\n      </button>\n    </li>\n  </ul>\n</div>'},2748:function(e,t){e.exports='<div class="context-dropdown dropdown-menu dropdown app-default-menu files-popover">\n  <ul class="context-menu-dropdown file-action-menu" acc-role="menu">\n    <li ng-repeat="menuItem in $ctrl.moreOptions track by $index" ng-if="::!(menuItem.shouldBeHidden && menuItem.shouldBeHidden())" class="ts-menu-item" acc-role="menu-item focus-default" aria-label="{{ ::menuItem.displayName }}">\n      <button class="ts-sym ts-svg" type="button" ng-click="menuItem.click()" data-tid="{{ menuItem.id }}" track-outcome="{{::$root.trackConstants.trackOutcome.select}}" track-scenario="{{::$root.trackConstants.trackScenario.selectFileAction}}" track-scenario-type="{{::$root.trackConstants.trackScenarioType.files}}" track-name="{{::$root.trackConstants.trackModuleName.fileActionButton}}" track-type="{{::$root.trackConstants.trackType.menuItem}}" track-data="{fileAction: \'{{::menuItem.id}}\', fileControl: \'file action menu\', fileId: \'{{::$ctrl.fileId}}\'}" track-summary="Choose a file action to perform - document stage">\n        <ng-include src="menuItem.svgPath"></ng-include>\n        <span aria-hidden="true">{{menuItem.displayName}}</span>\n      </button>\n    </li>\n  </ul>\n</div>'},2749:function(e,t,i){"use strict";var s=this&&this.__assign||function(){return(s=Object.assign||function(e){for(var t,i=1,s=arguments.length;i<s;i++){t=arguments[i];for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])}return e}).apply(this,arguments)};Object.defineProperty(t,"__esModule",{value:!0});var r,n=i(2750),o=i(87);!function(e){e.SameDocument="0",e.NewDocument="1"}(r=t.RebootMode||(t.RebootMode={}));var a=function(){function e(e,t,i,s,r,n,a,l,c,d,h,p,f,u,v,m,g,y,w,S,b,I,C,U,E,A,T,k,P,F,D,x,$,O,B,N,R){var M=this;this.$scope=e,this.$q=t,this.resources=s,this.$timeout=n,this.$state=a,this.$window=l,this.$sce=c,this.settingsService=d,this.layoutService=h,this.constants=p,this.loggingService=f,this.utilityService=u,this.filesUtilityService=v,this.authenticationService=m,this.routeUtilityService=g,this.filesDocStageHelperService=y,this.filesMessagePaneHelper=w,this.storageService=S,this.messageService=b,this.routeChangeService=I,this.navigationService=U,this.localizationService=E,this.copyLinkFactory=A,this.filesProviderFactory=T,this.createFileFactory=P,this.personalFilesDetailsService=F,this.filesNotificationService=D,this.filesOpenActionSettingService=x,this.shareDialogFactory=$,this.dialogService=O,this.filesExternalLinksService=B,this.filesRedeemService=R,this.webviewElement=null,this.iframeElement=null,this.isCloseButtonClick=!1,this.canPostConversation=!0,this.isConversationPanelOpen=!1,this.childMessageListner=function(e){if(M.iframeElement=M.iframeElement?M.iframeElement:document.getElementById("file-unified-app-viewer-frame"),M.iframeElement&&e.source===M.iframeElement.contentWindow)return M.commonMessageListner({data:e.data,origin:e.origin})},this.regionalOSSettingPromise=this.getRegionalOSSetting(),this.messageType=p.messages.types.newConversation,this.canPostConversation=C.canPostToCurrentChannel(),this.filesConversationEmptChatPaneHeader=i.instant(s.strings.files_conversation_empty_chat_pane_header),this.filesConversationEmptChatPaneBody=i.instant(s.strings.files_conversation_empty_chat_pane_body),this.logger=f.newLogger("FileViewer"),this.useWebview=d.valueAsBoolean(p.settings.names.isDesktopApp)&&!!l.electronSafeIpc&&l.desktopSettings.enableTabWebviews;var W,V,L=l.electronSafeIpc,_=this.layout.bind(this),H=!1,j=u.getIconClass({type:this.fileType})===p.css.fileIcons.excel;this.entityContext={id:this.fileId,objectUrl:this.objectUrl,serviceName:this.serviceName,title:this.fileName},this.jsApiHostSessionId=f.sessionId+"-"+this.scenario.id,this.routeDocumentViewerParams=g.getRootRouteParams(),L&&this.useWebview?(this.isWACFilesExperienceSSOEnabled()&&(this.authApiSecret=u.generateUUID()),j&&this.addZoomEventListenersForDesktopClient(),L.send(p.events.desktopApp.allowWebViewCreate,{enablePreload:!0}),L.once(p.events.desktopApp.webViewCreationEnabled,function(e,t){M.webviewElement=window.document.getElementById("file-unified-app-viewer-webview"),M.webviewElement.setAttribute("webpreferences","nativeWindowOpen=yes"),M.webviewElement.setAttribute("allowpopups",""),N.stampWebviewInstanceIdInWebPreferences(M.webviewElement,t),M.eventListener=new o.EventListener(M.webviewElement);M.eventListener.addListener("ipc-message",function(e){return M.webviewProcessMessage(e)});M.eventListener.addListener("crashed",function(e){return f.event(p.telemetry.webview.crashed,{errorEvent:JSON.stringify(e)})});M.eventListener.addListener("gpu-crashed",function(e){return f.event(p.telemetry.webview.gpuCrashed,{errorEvent:JSON.stringify(e)})});M.eventListener.addListener("plugin-crashed",function(e){return f.event(p.telemetry.webview.pluginCrashed,{errorEvent:JSON.stringify(e)})});M.eventListener.addListener("did-fail-load",function(e){f.event(p.telemetry.webview.loadFailed,{errorEvent:JSON.stringify({errorCode:e?e.errorCode:null,errorDescription:e?e.errorDescription:null})}),M.logger.error("loading failed - did-fail-load fired. errorCode={0} errorDescription={1}",e.errorCode,e.errorDescription)}),M.eventListener.addListener("dom-ready",_),M.eventListener.addListener("load-commit",function(e){e&&e.isMainFrame&&(V=W?(Date.now()-W).toString():""),H=e&&e.url&&e.url.startsWith(M.filesExpBaseUrl)}),M.eventListener.addListener("did-frame-finish-load",function(e){if(H){var t={filesExpFrameLoadTime:W?(Date.now()-W).toString():"",webviewFirstLoadCommitTime:V};M.logger.info("did-frame-finish-load scenario markers for files exp frame {0}",t),M.scenario.mark("files-experience-frame-load-time",t),H=!1}}),l.addEventListener("resize",_),M.init(),W=Date.now()})):(this.init(),this.registerForBaseEvents()),I.registerRouteChangeHandler(p.states.appDocumentViewer,this.routeChangeHandler.bind(this)),e.$on("$destroy",function(){l.removeEventListener("resize",_),l.removeEventListener("message",M.childMessageListner),M.eventListener&&M.eventListener.destroy(),v.isIntegratedUXEnabled(M.fileType)&&y.changeFileNameInTeamsChromeHeader(!1),w&&w.destroyContextMessagePane(),I.unregisterRouteChangeHandler(p.states.appDocumentViewer),M.isWACAppCreateNewDocumentScenarioEnabled()&&k.unregister(M.listenerRegistration),j&&M.removeZoomEventListenersForDesktopClient()}),this.isWACAppCreateNewDocumentScenarioEnabled()&&(this.listenerRegistration=k.register(this,e))}return e.$inject=["$scope","$q","$translate","resources","$rootScope","$timeout","$state","$window","$sce","settingsService","layoutService","constants","loggingService","utilityService","filesUtilityService","authenticationService","routeUtilityService","filesDocStageHelperService","filesMessagePaneHelper","storageService","messageService","routeChangeService","channelService","navigationService","localizationService","copyLinkFactory","filesProviderFactory","sharePointStore","createFileFactory","personalFilesDetailsService","filesNotificationService","filesOpenActionSettingService","shareDialogFactory","dialogService","filesExternalLinksService","desktopUtilityService","filesRedeemService"],e.prototype.addZoomEventListenersForDesktopClient=function(){var e=this.$window.electronSafeIpc;e&&this.useWebview&&(e.send(this.constants.events.desktopApp.autoZoomingEnabled,!1),this.logger.info("addZoomEventListeners called"))},e.prototype.removeZoomEventListenersForDesktopClient=function(){var e=this.$window.electronSafeIpc;e&&this.useWebview&&(e.send(this.constants.events.desktopApp.autoZoomingEnabled,!0),this.logger.info("removeZoomEventListeners called"))},e.prototype.routeChangeHandler=function(e,t,i,s){var r=this;if(s.name===this.constants.states.appDocumentViewer&&!e.defaultPrevented){this.dialogService.close();var n=!0===this.isCloseButtonClick?this.settingsService.valueFor(this.constants.settings.names.closeDocStagePromiseTimeout):this.settingsService.valueFor(this.constants.settings.names.navigationDocStagePromiseTimeout);this.logger.info("unloading timeout {0}",n);var o=function(){r.logger.info("navigating away from doc-stage on timeout "+n),r.routeChangeService.unregisterRouteChangeHandler(r.constants.states.appDocumentViewer),r.$state.go(t,i)};if(0==n)return void o();this.toStateForUnloading=t,this.toStateParamsForUnloading=i,this.unlockFilePromise=this.filesDocStageHelperService.unlockFile(n).finally(function(){return o()}),e.preventDefault()}},e.prototype.registerForBaseEvents=function(){this.$window.addEventListener("message",this.childMessageListner)},e.prototype.commonMessageListner=function(e){switch(e.data.channel){case"multi-window-manager-channel":return this.handlePostMessagesEvents(e.data.payload,e.origin)}},e.prototype.handleGetWacAuthToken=function(e,t){var i=this,s=e.payload.authApiSecret,r=e.payload.Resource,n=e.payload.RequestId,o=e.payload.IdentityType,a=e.payload.Claims;if(this.authApiSecret&&s==this.authApiSecret){var l=function(t,s){var r={eventId:teamspace.services.ChildWindowEventRequest.FilesExperienceSendData,correlationId:e.correlationId,payload:{wacMessage:{MessageId:"Host_SetAuthToken",SendTime:Date.now(),Values:{AuthToken:t,Error:s,RequestId:n,IdentityType:o}},authApiSecret:i.authApiSecret}};i.filesDocStageHelperService.sendPostMessage(r,i.iframeElement,i.webviewElement)};this.authenticationService.getAuthTokens([r],a,!0).then(function(e){l(e,"")}).catch(function(t){i.logger.error("ERROR: failed to get wac auth token: correlationId={0}, error={1}",e.correlationId,t),l("",t)})}},e.prototype.handlePostMessagesEvents=function(e,t){var i=this;if(t&&t.toLocaleLowerCase()==this.filesDocStageHelperService.getFilesExperienceOrigin().toLocaleLowerCase())switch(this.logger.info("Post message received for event {0}",e.eventId),e.eventId){case teamspace.services.ChildWindowEventRequest.WindowReady:this.logger.info("Child frame has reported ready state");break;case teamspace.services.ChildWindowEventRequest.WindowInitialized:this.logger.info("Child frame has reported it is fully initialized");break;case teamspace.services.ChildWindowEventRequest.NewWindow:this.logger.info("Child frame requested to open new window directly (blocked)");break;case teamspace.services.ChildWindowEventRequest.AadGetToken:var r=e.eventId;if(e.correlationId&&e.payload){n=e.payload.resource;return this.filesUtilityService.updateTokenWarmingRule(n),this.logger.info("Child frame requested AAD token: resource={0}, correlationId={1}",n,e.correlationId),this.authenticationService.getAuthTokens([n]).then(function(t){var s={eventId:r,correlationId:e.correlationId,payload:{token:t}};i.filesDocStageHelperService.sendPostMessage(s,i.iframeElement,i.webviewElement)}).catch(function(t){i.logger.error("ERROR: failed to get auth token: correlationId={0}, error={1}",e.correlationId,t)})}this.logger.error("Expected payload or correlationId for {0} but got none",r);break;case teamspace.services.ChildWindowEventRequest.AadGetCurrentUser:if(e.correlationId)return this.logger.info("Child frame requested current logged in user correlationId={0}",e.correlationId),this.authenticationService.getUserInformation().then(function(t){var s={eventId:e.eventId,correlationId:e.correlationId,payload:{authUser:t}};i.filesDocStageHelperService.sendPostMessage(s,i.iframeElement,i.webviewElement)}).catch(function(t){i.logger.error("ERROR: failed to get current logged in user correlationId={0}, error={1}",e.correlationId,t),i.hideSpinner(),i.handleScenario({status:!1,errorCode:i.constants.files.fileViewErrorCodes.aadGetCurrentUserFailure,errorMessage:i.constants.files.fileViewErrorMessages.aadGetCurrentUserFailure,sendTime:Date.now()}),i.displayTitleBar=!0,i.fileErrorCode=i.constants.files.error.unknown+"_unifiedapp"});this.logger.error("ERROR: AadGetCurrentUser request was made but no correlationId was given");break;case teamspace.services.ChildWindowEventRequest.AadClearCache:if(e.payload){var n=e.payload.resource;this.logger.info("Child frame requested clear adal cache:  resource={0}, correlationId={1}",n,e.correlationId),n&&this.authenticationService.clearAdalCache(n)}else this.logger.error("Expected data for event {0} but got none",e.event);break;case teamspace.services.ChildWindowEventRequest.HideFileViewerLoader:this.hideSpinner();break;case teamspace.services.ChildWindowEventRequest.StopDocStageScenario:e.payload&&this.handleScenario(e.payload);break;case teamspace.services.ChildWindowEventRequest.GetDriveItemResponse:S=e.payload&&e.payload.sendTime&&Date.now()-e.payload.sendTime;return this.scenario.mark("exp-request-drive-item",{ipcTimeOverhead:S}),this.$q.all([this.redeemPromise,this.regionalOSSettingPromise]).then(function(t){var r=t[0],n=t[1],o=r.sensitivityLabel&&r.sensitivityLabel.protectionEnabled;i.scenario.mark("redeem-post-success");var a=s(s({},r),{driveItemCallStartTime:i.driveItemCallStartTime,driveItemCallEndTime:Date.now(),localeFromOS:n,fileActions:i.filesUtilityService.isIntegratedUXEnabled(i.fileType)?i.filesDocStageHelperService.getFileActions(r,i.hideClose,i.fileType):null,flights:i.getFileScenarioFlights(),sessionOrigin:i.getWacSessionOrigin(),navId:i.routeDocumentViewerParams.navId,shareUrl:i.routeDocumentViewerParams.shareUrl,authApiSecret:i.authApiSecret,templateId:i.settingsService.valueAsBoolean(i.constants.settings.names.enableWACCreateNewTemplateDocument)?i.routeDocumentViewerParams.templateId:void 0,userClickTime:i.userClickTime,file:s(s({},r.file),{irmEnabled:o})});i.isWACAppDocRebootScenarioEnabled()&&(a.rebootOverrideData=i.routeDocumentViewerParams.rebootOverrideData);var l={eventId:e.eventId,correlationId:e.correlationId,payload:a};i.logger.info("sending redeem response to Files experience"),i.filesDocStageHelperService.sendPostMessage(l,i.iframeElement,i.webviewElement);var c=i.utilityService.getIconClass({type:i.fileType})===i.constants.css.fileIcons.word,d=r.currentUserRole&&r.currentUserRole.readOnly;i.fileName!=r.name&&(i.fileName=r.name),(d&&!i.isWordRibbonInReadOnlyModeEnabled()||o)&&c?i.moveEditInBrowserFromMoreOptions||(i.displayTitleBar=!0,i.isEditMode=!0):i.filesUtilityService.isIntegratedUXEnabled(i.fileType)&&!1===i.displayTitleBar&&i.filesDocStageHelperService.changeFileNameInTeamsChromeHeader(!0,i.fileName)});case teamspace.services.ChildWindowEventRequest.AddScenarioMarker:e.payload&&this.addScenarioMarker(e.payload);break;case teamspace.services.ChildWindowEventRequest.FilesExperienceSendData:switch(this.logger.info("Post message received with messageId {0}",e.payload.MessageId),e.payload.MessageId){case"App_GetAuthToken":this.isWACFilesExperienceSSOEnabled()&&this.handleGetWacAuthToken(e,t);break;case"App_AccessibilityLoopComplete":var o="backward"!==e.payload.Values.Direction;this.layoutService.navigateToNextLandmark(o);break;case"Wac_ActionComplete":this.logger.info("wac action completed {0} ",e.payload);var a=e.payload.Values&&e.payload.Values.Action,l=e.payload.Values&&e.payload.Values.wdUserSession;if(!a)return void this.logger.info("unknown action reported from WAC");if("OpenInBrowser"===a)return void this.findAndPerformActionButtonClick("office-open-in-new-tab",l);"OpenInDesktop"===a&&this.filesDocStageHelperService.logAction("Open_In_Desktop",this.fileId,this.fileType);var c=e.payload.sendTime,d=e.payload.SendTime,h=d&&c?(c-d).toString():"",p=c?(Date.now()-c).toString():"",f=d?(Date.now()-d).toString():"",u=e.payload.Values&&e.payload.Values.wdUserSession,v=this.constants.scenarios.files.openOfficeFileInDesktop,m=this.loggingService.newScenario(v);m.eventData.entryPoint=this.serviceName,m.eventData.context=this.ctx||this.utilityService.getUrlRootContext(),m.eventData.type=this.fileType,m.eventData.viewerType=teamspace.services.files.modules.sharePoint.FilePreviewerTypes.UnifiedApp,m.stop({ipcOverheadToExperienceFromWac:h,ipcOverheadToMainAppFromExperience:p,ipcOverHead:f,wdUserSession:u,jsApiHostSessionId:this.jsApiHostSessionId});break;case"Action_Button_Click":var g=e.payload&&e.payload.SendTime,y={ipcOverheadToExperienceFromWac:g&&e.payload.receivedTime?(e.payload.receivedTime-g).toString():"",ipcOverheadToMainAppFromExperience:e.payload.receivedTime?(Date.now()-e.payload.receivedTime).toString():"",ipcOverHead:g&&(Date.now()-g).toString(),ipcCorrelationId:e.payload.CorrelationId,ipcwdUserSession:e.payload.wdUserSession,jsApiHostSessionId:this.jsApiHostSessionId};this.logger.info("wdUserSession {0} correlationId {1} hostSessionId {2}",e.payload.wdUserSession,e.payload.CorrelationId,this.jsApiHostSessionId);var w=this.constants.scenarios.files.actionButton+"_"+e.payload.button;this.loggingService.newScenario(w).stop(y),this.handleActionButtonsClick(e.payload),this.filesDocStageHelperService.logAction(e.payload.button,this.fileId,this.fileType);break;case"Unload":var S=e.payload.sendTime&&Date.now()-e.payload.sendTime;this.$timeout.cancel(this.unlockFilePromise),this.closeFileUnlockScenario(S),this.routeChangeService.unregisterRouteChangeHandler(this.constants.states.appDocumentViewer),this.$state.go(this.toStateForUnloading,this.toStateParamsForUnloading);break;case"Reboot":this.rebootFile(e.payload);break;case"File_Renamed":if(this.settingsService.valueAsBoolean(this.constants.settings.names.enableWACFileRenameScenario)&&e.payload.NewName){var b=e.payload.NewName+"."+this.fileType;b!==this.fileName&&(this.fileName=b,this.$scope.$apply(function(){i.filesDocStageHelperService.changeFileNameInTeamsChromeHeader(!0,i.fileName)}))}break;case"Error":this.logger.error("ErrorMessage: "+e.payload.errorMessage),this.handleErrorFromNStarExperience(e.payload);break;case"App_SwitchMode":this.handleModeSwitch(e.payload);break;case"Get_ReplyChainId":var I=void 0,C=this.routeDocumentViewerParams.messageId;C?I=this.$q.resolve(C):(this.replyChainIdPromise||(this.replyChainIdPromise=this.filesMessagePaneHelper.getReplyChainIdFromFileId(this.fileId,this.threadId)),I=this.replyChainIdPromise),I.then(function(t){var s={eventId:teamspace.services.ChildWindowEventRequest.FilesExperienceSendData,correlationId:e.correlationId,payload:{replyChainId:t,threadId:i.threadId}};i.filesDocStageHelperService.sendPostMessage(s,i.iframeElement,i.webviewElement)});break;case"Open_File":this.gotoSPOFile(e.payload);break;case"App_CreateNewDocument":this.createNewFile(e.payload);break;case"App_WopiInfoFromUrl":this.settingsService.valueAsBoolean(this.constants.settings.names.enableExternalLinkScenario)&&(e.payload.documentUrl=this.entityContext.objectUrl,this.filesExternalLinksService.handleWopiInfo(e.payload));break;case"App_RefreshSessionInfo":if(this.settingsService.valueAsBoolean(this.constants.settings.names.enableFilesOfficeTokenRefresh)){var U=this.filesUtilityService.isNStarFilesExperienceEnabledInMainWindow(this.fileType),E=this.constants.scenarios.files.viewFileAppRefreshToken,A=this.loggingService.newScenario(E,null);A.eventData={viewerType:"UnifiedApp",correlationId:e.correlationId,wacSessionId:this.jsApiHostSessionId,fileId:this.fileId,shareId:this.routeDocumentViewerParams.shareId,type:this.filesUtilityService.scrubUnknownFileExtensions(this.fileType)};var T=U?teamspace.services.IFileRedeemScenario.NorthStarFileViewer:teamspace.services.IFileRedeemScenario.Thumbnail,k={fileId:this.fileId,shareId:this.routeDocumentViewerParams.shareId,originScenario:E},P=this.settingsService.valueAsBoolean(this.constants.settings.names.enableInValidAudienceErrorRetryForUnifiedApps);A.mark("refresh-handler-redeem-started"),this.filesRedeemService.redeemFile(this.objectUrl,this.routeDocumentViewerParams.shareUrl,T,this.constants.wopiActions.edit,k,this.routeDocumentViewerParams.baseUrl,P,E).then(function(t){var s,r,n,o,a,l,c,d=null===(s=null===t||void 0===t?void 0:t.openWith)||void 0===s?void 0:s.wac;A.mark("refresh-handler-redeem-completed");var h=null===(o=null===(n=null===(r=e.payload)||void 0===r?void 0:r.Values)||void 0===n?void 0:n.Tokens)||void 0===o?void 0:o.map(function(e){return i.getRefreshedToken(e,d)}),p={MessageId:"Host_RefreshSessionInfo",SendTime:Date.now(),CorrelationId:e.correlationId,Values:h},f={eventId:teamspace.services.ChildWindowEventRequest.FilesExperienceSendData,payload:p};i.logger.info("Sending refresh session info to WAC ",f.payload.CorrelationId,"Send-time:",f.payload.SendTime,"Error:",null===(a=f.payload.Values)||void 0===a?void 0:a.Errors),A.mark("refresh-handler-send-wac-message"),A.eventData={wacMessage:""+((null===(l=h.Values)||void 0===l?void 0:l.Errors)?null===(c=h.Values)||void 0===c?void 0:c.Errors:"success")},A.stop(),i.filesDocStageHelperService.sendPostMessage(f)}).catch(function(t){var s,r,n,o;A.mark("refresh-handler-redeem-failed");var a=t.statusCode||t.errorCode||t.code,l=t.errorMessage&&t.errorMessage.error&&t.errorMessage.error.message,c=null===(n=null===(r=null===(s=e.payload)||void 0===s?void 0:s.Values)||void 0===r?void 0:r.Tokens)||void 0===n?void 0:n.map(function(e){return{Name:e,Errors:[{Id:a,Details:{value:l}}]}}),d={MessageId:"Host_RefreshSessionInfo",SendTime:Date.now(),CorrelationId:e.correlationId,Values:c},h={eventId:teamspace.services.ChildWindowEventRequest.FilesExperienceSendData,payload:d};A.mark("refresh-handler-sending-wac-error"),A.eventData={wacMessage:a+" : "+l},i.handleRefreshTokenError(t,A),i.logger.error("Sending failed refresh session info to WAC ",h.payload.CorrelationId,"Send-time:",h.payload.SendTime,"Error:",null===(o=h.payload.Values)||void 0===o?void 0:o.Errors),i.filesDocStageHelperService.sendPostMessage(h)}).finally(function(){A=null})}}break;default:this.logger.info("Child frame has reported event {0} which doesn't exist {1}",e.eventId,e)}else this.logger.error("ERROR: invalid origin {0}",t)},e.prototype.handleRefreshTokenError=function(e,t){var i=e.errorMessage&&e.errorMessage.error,s=i&&i.innerError,r=e.errorCode||e.code||e.internalErrorCode||i&&i.code,n=i&&i.message,o=_.get(e,"errorMessage.error"),a=o&&o["error.errorMessage.error"];if(n=n||(e.message||e.internalErrorCode||a),t.eventData.SPRequestId||(t.eventData.SPRequestId=s&&s["request-id"]||e.headers&&e.headers.sprequestguid,t.eventData.SPPerf=(e.headers&&e.headers.spclientservicerequestduration)+" : "+n+"}"),r!==this.constants.errorCodes.networkOffline){var l=e.statusCode;if(l){if("number"!=typeof l){var c="type: "+typeof l+", status: "+l;return n=n?c+", message: "+n:c,void this.scenario.fail({statusCode:l,errorCode:r,errorMessage:n})}switch(l){case this.constants.responseCode.clientFailure:case this.constants.responseCode.badRequest:case this.constants.responseCode.internalServerError:case this.constants.responseCode.serviceUnavailable:case this.constants.responseCode.ok:this.scenario.fail({statusCode:l,errorCode:r,errorMessage:n});break;default:this.scenario.incomplete({statusCode:l,errorMessage:n,errorCode:r})}}else this.scenario.fail({errorCode:r,errorMessage:n})}else this.scenario.incomplete({errorCode:r,errorMessage:n})},e.prototype.getRefreshedToken=function(e,t){var i=t.accessTokenExpiry,s=t[e.charAt(0).toLowerCase()+e.slice(1)];return s?{Name:e,Expiry:i,Value:s}:{Name:e,Errors:[{Id:"404",Details:"Could not find this token"}]}},e.prototype.getRegionalOSSetting=function(){var e=this,t=this.$q.defer(),i=this.settingsService.valueAsBoolean(this.constants.settings.names.enableRegionalSettingFromOS),s=this.utilityService.getIconClass({type:this.fileType})===this.constants.css.fileIcons.excel;return i&&s&&this.$window.getLocaleInfoAsync?(this.scenario.mark("get-regional-setting-call-start"),this.$window.getLocaleInfoAsync().then(function(i){e.scenario.mark("get-regional-setting-call-end"),t.resolve(i&&i.regionalFormat)}).catch(function(i){e.scenario.mark("get-regional-setting-call-failed",{reason:JSON.stringify(i)}),t.resolve(void 0)})):t.resolve(void 0),t.promise},e.prototype.isWACAppDocRebootScenarioEnabled=function(){return this.settingsService.valueAsBoolean(this.constants.settings.names.enableWACAppDocRebootScenario)},e.prototype.getFileScenarioFlights=function(){return{enableWACAppCreateNewDocumentScenario:this.isWACAppCreateNewDocumentScenarioEnabled(),enableWACAppDocRebootScenario:this.isWACAppDocRebootScenarioEnabled(),enableWordRibboninReadMode:this.isWordRibbonInReadOnlyModeEnabled(),enableWACAppModeSwitch:this.settingsService.valueAsBoolean(this.constants.settings.names.enableWACAppModeSwitch),enablePassingDynamicThrottlingSignalToWAC:this.settingsService.valueAsBoolean(this.constants.settings.names.enablePassingDynamicThrottlingSignalToWAC),enableWACCopyLinkScenario:this.settingsService.valueAsBoolean(this.constants.settings.names.enableWACCopyLinkScenario),hideWACOneDriveFileLocationPicker:this.hideWACOneDriveFileLocationPickerButton(),enableWACUserAccessScenario:this.settingsService.valueAsBoolean(this.constants.settings.names.enableWACUserAccessScenario),enableWACFileRenameScenario:this.settingsService.valueAsBoolean(this.constants.settings.names.enableWACFileRenameScenario),enableFilesNotifications:this.settingsService.valueAsBoolean(this.constants.settings.names.enableFilesNotifications),enableFileOpenExperiment:this.settingsService.valueAsBoolean(this.constants.settings.names.enableFileOpenExperiment),enableWebAsDefaultFileOpenPreference:this.settingsService.valueAsBoolean(this.constants.settings.names.enableWebAsDefaultFileOpenPreference),enableFileClickOpeningInWeb:this.settingsService.valueAsBoolean(this.constants.settings.names.enableFileClickOpeningInWeb),enableExternalLinkScenario:this.settingsService.valueAsBoolean(this.constants.settings.names.enableExternalLinkScenario),enableWACFilesExperienceSSO:this.isWACFilesExperienceSSOEnabled(),enableRootDomainCheckForWACEvents:this.settingsService.valueAsBoolean(this.constants.settings.names.enableRootDomainCheckForWACEvents),enableOfficeFileOpenWithFileGetUrl:this.settingsService.valueAsBoolean(this.constants.settings.names.enableOfficeFileOpenWithFileGetUrl),enableFilesRemoveObsoleteOfficeSessionContextParams:this.settingsService.valueAsBoolean(this.constants.settings.names.enableFilesRemoveObsoleteOfficeSessionContextParams),enableFilesUnifiedAppCustomFonts:this.settingsService.valueAsBoolean(this.constants.settings.names.enableFilesUnifiedAppCustomFonts),enableFilesOfficeTokenRefresh:this.settingsService.valueAsBoolean(this.constants.settings.names.enableFilesOfficeTokenRefresh)}},e.prototype.hideWACOneDriveFileLocationPickerButton=function(){return this.settingsService.valueAsBoolean(this.constants.settings.names.hideWACOneDriveFileLocationPicker)&&this.useWebview},e.prototype.isWACFilesExperienceSSOEnabled=function(){return this.settingsService.valueAsBoolean(this.constants.settings.names.enableWACFilesExperienceSSO)&&this.useWebview},e.prototype.isWordRibbonInReadOnlyModeEnabled=function(){return this.utilityService.getIconClass({type:this.fileType})===this.constants.css.fileIcons.word&&this.settingsService.valueAsBoolean(this.constants.settings.names.enableWordRibboninReadMode)},e.prototype.isWXPExtension=function(e){var t=this.utilityService.getIconClass({type:e});return t===this.constants.css.fileIcons.word||t===this.constants.css.fileIcons.powerpoint||t===this.constants.css.fileIcons.excel},e.prototype.onStateChanged=function(e){this.isWACAppCreateNewDocumentScenarioEnabled()&&(e.createErrorData?e.createErrorData.errorCode===this.constants.files.error.filenameCollision&&(this.filesNotificationService.showFailureNotification(this.resources.strings.files_fileRenameConflictError),this.logger.info("File name collision")):e.viewerRoute&&e.createdEntityWacUrl&&(e.viewerRoute.documentViewerParams.wacScenario=this.constants.wacScenario.createNewDoc,this.filesUtilityService.navigateToNewFile(e)))},e.prototype.gotoSPOFile=function(e){var t=e.serviceName?e.serviceName:this.constants.files.serviceName.teams,i={documentViewerParams:{fileType:e.fileType,serviceName:t,objectUrl:e.objectUrl,threadId:e.threadId,messageId:e.messageId,baseUrl:e.baseUrl,fileId:e.fileId,viewerAction:this.constants.files.fileActions.viewer.view},viewerState:this.constants.states.appDocumentViewer};return this.navigationService.navigateToFileViewer(i)},e.prototype.handleErrorFromNStarExperience=function(e){this.hideSpinner(),this.handleScenario(s({status:!1},e)),this.displayTitleBar=!0,this.fileErrorCode=this.constants.files.error.unknown+"_unifiedapp",this.allowDownloadOnError=e.allowDownload},e.prototype.handleActionButtonsClick=function(e){switch(e.button){case"Conversation":this.layoutService.rightRailVisible?this.layoutService.rightRailHide():this.isConversationPanelOpen?this.isConversationPanelOpen=!1:this.setUpConversationPane();break;case"Close":this.isCloseButtonClick=!0,this.onClose();break;case"Open_In_Desktop":this.findAndPerformActionButtonClick("office-open-in-desktop-app");break;case"Open_In_Browser":this.findAndPerformActionButtonClick("office-open-in-new-tab",e.wdUserSession);break;case"Download":this.findAndPerformActionButtonClick("download-office-document");break;case"Share":this.settingsService.valueAsBoolean(this.constants.settings.names.enableWACCopyLinkScenario)&&this.handleCopyLink(e);break;case"CheckUserAccessAndGrantPermissions":this.settingsService.valueAsBoolean(this.constants.settings.names.enableWACUserAccessScenario)&&this.showOdspShareDialog(e,this.constants.files.odspShareDialog.dialogMode.userAccess)}},e.prototype.findAndPerformActionButtonClick=function(e,t){var i=this.moreOptions.filter(function(t){return t.id===e})[0];t?i.click(void 0,void 0,void 0,void 0,t):i.click()},e.prototype.initiateConversation=function(e){var t=this,i=this.loggingService.newScenario(this.constants.scenarios.files.toggleChatOpened);this.redeemPromise.then(function(e){var i=e,s=i.webDavUrl,r=i.name,n=i.sharepointIds,o=n.siteUrl,a=n.listItemUniqueId;return{serverRelativeUrl:t.filesUtilityService.extractServerRelativeUrl(s),siteUrl:o,objectUrl:s,objectId:a,title:r,type:t.fileType}}).then(function(s){var r=t.createMessageWithCurrentFile(e,s);return r.scenario=i,t.messageService.createMessage(r)}).then(function(e){t.isConversationPanelOpen=!1,t.storageService.set(""+t.constants.files.strings.saveChatIsExpanded,!0),t.filesMessagePaneHelper.initializeContextMessagePane(t.fileId,t.threadId,teamspace.services.files.modules.sharePoint.FilePreviewerTypes.UnifiedApp,!1,e.messageId),t.replyChainIdPromise=null}).then(function(){return i.stop()}).catch(function(e){var s="Failed to start conversation";t.loggingService.error(s),i.fail({error:s})})},e.prototype.createMessageWithCurrentFile=function(e,t){var i={conversationId:this.threadId,replyChainId:"",messageSubject:e?e.subject:"",messageBody:e?e.message:"",messagePreview:e?e.preview:"",fileAttachments:e?e.attachments:[],extensions:e?e.extensions:"",mentions:e?e.mentions:"",embeddedLinks:e?e.embeddedlinks:[],isHtml:!0,importance:e?e.importance:null,clientId:SkypeX.Services.Utilities.newClientMessageId(),draftObjectId:e?e.draftObjectId:""};return i.fileAttachments.push(t),i},e.prototype.setUpConversationPane=function(){var e=this,t=this.loggingService.newScenario(this.constants.scenarios.files.toggleChatOpened),i=/p2p/i.test(this.serviceName);if(i)return this.storageService.set(""+this.constants.files.strings.saveChatIsExpanded,!0),this.initContextMessagePane(i).then(function(t){e.filesMessagePaneHelper.showRightRail(e.threadId,void 0,teamspace.services.ReplyChainIdType.MessageId,i)}),void t.stop();this.replyChainIdPromise||(this.replyChainIdPromise=this.filesMessagePaneHelper.getReplyChainIdFromFileId(this.fileId,this.threadId)),this.replyChainIdPromise.then(function(s){s?(e.storageService.set(""+e.constants.files.strings.saveChatIsExpanded,!0),e.initContextMessagePane(i).then(function(t){e.filesMessagePaneHelper.showRightRail(e.threadId,s,teamspace.services.ReplyChainIdType.ParentMessageId,i)}),t.stop()):e.isConversationPanelOpen=!0}).catch(function(){e.replyChainIdPromise=null;var i="Failed to get reply chain";e.loggingService.error(i),t.fail({error:i})})},e.prototype.initContextMessagePane=function(e){return this.filesMessagePaneHelper.initializeContextMessagePane(this.fileId,this.threadId,teamspace.services.files.modules.sharePoint.FilePreviewerTypes.UnifiedApp,e,void 0,!1)},e.prototype.closeConversationPane=function(){this.isConversationPanelOpen=!1},e.prototype.addScenarioMarker=function(e){var t=e.errorMessage,i=e.sendTime,s=e.scenarioMarker,r=e.cached,n=i&&Date.now()-i;this.logger.info("scenarioMarker {0}",s),this.scenario.mark(s,{ipcTimeOverhead:n,errorMessage:t,cached:r})},e.prototype.closeFileUnlockScenario=function(e){var t=this.routeDocumentViewerParams.serviceName?decodeURIComponent(this.routeDocumentViewerParams.serviceName):void 0,i=this.filesDocStageHelperService.getPivot(t),s=this.constants.scenarios.files.closeFile+"_"+i,r=this.loggingService.findScenario(s);r?r.stop({ipcTimeOverhead:e,openFileScenarioId:this.scenario&&this.scenario.id}):this.logger.error("file-unified-app-viewer: could not find scenario"),this.logger.info("navigating away from doc-stage on Unload post-message")},e.prototype.handleScenario=function(e){var t=this,i=e.status,s=e.sendTime,r=e.officeSessionId,n=e.officeBootstrapperVersion,o=s&&Date.now()-s;(this.redeemPromise||this.$q.resolve(void 0)).then(function(s){var a,l=(null===(a=null===s||void 0===s?void 0:s.openWith)||void 0===a?void 0:a.wac)||{},c=l.clientThrottlingProtection,d=l.requestedCallThrottling;if(i){var h=e.deltaWithPerceivedBoot;t.scenario.stop({deltaWithPerceivedBoot:h,officeSessionId:r,ipcTimeOverhead:o,clientThrottlingProtection:c,requestedCallThrottling:d}),t.filesOpenActionSettingService.handleFileOpenPreferenceUpdate(teamspace.services.FileOpenPreference.Teams,{fileType:t.fileType,serviceName:t.serviceName,context:t.ctx,fileAction:t.filesUtilityService.getFileActionName(teamspace.services.FileOpenPreference.Teams)})}else{var p=e,f=p.errorMessage,u=p.errorCode;t.scenario.fail({errorMessage:f,errorCode:u,officeSessionId:r,ipcTimeOverhead:o,clientThrottlingProtection:c,requestedCallThrottling:d})}t.logger.info("officeSessionId {0} hostSessionId {1} officeBootstrapperVersion {2}",r,t.jsApiHostSessionId,n)})},e.prototype.handleFocus=function(e){var t=e.target.dataset.focusDirection||(e.shiftKey?"backward":"forward"),i={MessageId:"Host_AccessibilityLoopComplete",SendTime:Date.now(),Values:{Direction:t}},s={eventId:teamspace.services.ChildWindowEventRequest.FilesExperienceSendData,payload:i};(this.iframeElement||this.webviewElement).focus(),this.filesDocStageHelperService.sendPostMessage(s,this.iframeElement,this.webviewElement)},e.prototype.handleModeSwitch=function(e){var t=this;if(this.filesUtilityService.isIntegratedUXEnabled(this.fileType)){if(this.moveEditInBrowserFromMoreOptions)return void this.logger.info("ignoring App_SwitchMode post-message from wac frame when intentional RO mode is set");var i=e.Editable;if("view"===e.NewMode)this.$scope.$apply(function(){t.displayTitleBar=!0,t.isEditMode=!i}),this.filesDocStageHelperService.changeFileNameInTeamsChromeHeader(!1);else if("edit"===e.NewMode){var s=this.constants.scenarios.files.editFileFullScreen+"_"+this.serviceName,r=this.loggingService.findScenario(s);r?r.stop({jsApiHostSessionId:this.jsApiHostSessionId}):this.logger.error("scenario corresponging to excel file edit not found"),this.displayTitleBar=!1,this.isEditMode=!0,this.filesDocStageHelperService.changeFileNameInTeamsChromeHeader(!0,this.fileName)}else this.logger.error("Switched to unknown mode: "+e.NewMode)}},e.prototype.handleCopyLink=function(e){var t=this;this.logger.info("Received a Share post message from WAC, calling copyLinkFactory to prepare copy link dialog"),this.copyLinkFactory.create({file:{getExtension:function(){return t.fileType},getUrl:function(){return t.objectUrl},getBaseApiUrl:function(){return t.filesUtilityService.extractSiteUrl(t.objectUrl)},getId:function(){return t.fileId},getTitle:function(){return t.fileName},getIsSubdirectory:function(){return!1}},fileContext:{serviceName:this.serviceName,provider:void 0,threadId:this.threadId},sharepointUrl:this.objectUrl,origin:this.constants.shareDialogOrigin.wac,navId:e.Values&&e.Values.nav}).execute({selectedFilesCount:1,scope:this.$scope,onCloseFocusId:"",event:void 0})},e.prototype.showOdspShareDialog=function(e,t){var i=this;this.logger.info("Received a Share post message from WAC, calling shareDialogFactory to prepare share dialog"),this.shareDialogFactory.create({file:{getExtension:function(){return i.fileType},getUrl:function(){return i.objectUrl},getBaseApiUrl:function(){return i.filesUtilityService.extractSiteUrl(i.objectUrl)},getId:function(){return i.fileId},getTitle:function(){return i.fileName},getIsSubdirectory:function(){return!1}},fileContext:{serviceName:this.serviceName,provider:void 0,threadId:this.threadId},sharepointUrl:this.objectUrl,origin:this.constants.shareDialogOrigin.wac,navId:e.Values&&e.Values.nav,id:e.Values&&e.Values.Id,persons:e.Values&&e.Values.Persons.map(function(e){return{displayName:e.DisplayName,id:e.Id,provider:e.Provider}}),mode:t}).execute({selectedFilesCount:1,scope:this.$scope,onCloseFocusId:"",event:void 0})},e.prototype.init=function(){var e=this.getNStarViewerExpUrl();this.fileViewerExpUrl=this.$sce.trustAsResourceUrl(e)},e.prototype.getNStarViewerExpUrl=function(){var e=(this.utilityService.djb2_hash(""+this.objectUrl)||"").toString(),t=this.filesDocStageHelperService.getFilesExperienceOrigin()+"/files/apps/com.microsoft.teams.files/files/"+e+"/open";this.filesExpBaseUrl=t;var i=this.settingsService.getActiveTheme(),s=this.localizationService.getLocale(),r=this.isTabbedFile(),n={agent:"postmessage",objectUrl:this.objectUrl,fileId:this.fileId,fileType:this.fileType,messageId:this.routeDocumentViewerParams.messageId,ctx:this.ctx,scenarioId:this.scenario&&this.scenario.id||null,locale:s,isTabbedFile:r,theme:i,version:this.settingsService.getOrbitalVersion(this.constants.settings.orbitals.files)},o=this.settingsService.getRing(),a={"ring.id":o&&o.id||"",createdTime:Date.now()},l=t+"?"+Object.keys(n).filter(function(e){return n[e]}).map(function(e){return encodeURIComponent(e)+"="+encodeURIComponent(n[e])}).join("&")+"&"+Object.keys(a).map(function(e){return"setting="+e+":"+a[e]}).join("&"),c=this.utilityService.parseUrl(l),d="iframe-container.html#iframeurl="+encodeURIComponent(this.$sce.trustAsResourceUrl(c.href))+"&skipDomainValidation=true";return this.useWebview?d:l},e.prototype.webviewProcessMessage=function(e){return this.commonMessageListner({data:e.args[1],origin:e.args[0]})},e.prototype.layout=function(){if(this.webviewElement&&this.$window.electronSafeIpc){this.uuid||(this.uuid=this.utilityService.generateUUID());var e=this.webviewElement.clientWidth,t=this.webviewElement.clientHeight;this.$window.electronSafeIpc.send(this.constants.events.desktopApp.webViewResize,{width:e,height:t,uuid:this.uuid})}},e.prototype.isTabbedFile=function(){var e=this.routeUtilityService.getRootRouteParams();return e&&e.middlePane&&e.middlePane.startsWith("tab::")||"pinned-tab"===this.scenario.eventData.entryPoint},e.prototype.createNewFile=function(e){if(this.isWACAppCreateNewDocumentScenarioEnabled()&&e.appID){var t=void 0;switch(e.appID){case this.constants.files.wac.applications.word:t=this.constants.files.createFileExtensions.word;break;case this.constants.files.wac.applications.excel:t=this.constants.files.createFileExtensions.excel;break;case this.constants.files.wac.applications.powerpoint:t=this.constants.files.createFileExtensions.powerpoint;break;case this.constants.files.wac.applications.visio:t=this.constants.files.createFileExtensions.visio}var i=void 0,s=void 0,r=this.personalFilesDetailsService.getPersonalSiteInfo();if(r&&(i=this.filesUtilityService.extractServerRelativeUrl(r.personalRootFolderUrl),s=r.personalSiteUrl),t&&i&&s)try{this.createFileFactory.create({fileContext:{serviceName:this.constants.files.serviceName.personal,provider:this.filesProviderFactory.create(teamspace.services.files.FilesProviderType.Sharepoint),threadId:void 0,listenerId:this.listenerRegistration.getId(),siteUrl:s,serverRelativeRootUrl:i,rootRelativeFolderUrl:void 0,sortedAscending:!1,pageSize:0,libraryId:"default",libraryTitle:void 0,templateId:e.template},extension:t}).execute()}catch(t){this.logger.info("Create new document from WAC failed. Error: {0}, WAC Session ID: {1}",t,e.wdUserSession),this.filesNotificationService.showFailureNotification(this.resources.strings.files_fileCreateFailedGeneric)}else this.logger.info("Create new document from WAC failed because of missing information. extension: {0}, serverRelativeRootUrl: {1}, siteUrl: {2}, WAC Session ID: {3}",e.appID,null==i,null==s,e.wdUserSession),this.filesNotificationService.showFailureNotification(this.resources.strings.files_fileCreateFailedGeneric)}},e.prototype.isWACAppCreateNewDocumentScenarioEnabled=function(){return this.settingsService.valueAsBoolean(this.constants.settings.names.enableWACAppCreateNewDocumentScenario)},e.prototype.rebootFile=function(e){if(e.rebootFromScratch){if(this.isTabbedFile()&&!this.isWACAppDocRebootScenarioEnabled())return void this.logger.info("wrong reboot file path");this.logger.log("Reboot Mode: "+e.rebootMode);var t=this.routeDocumentViewerParams;if(this.isWACAppDocRebootScenarioEnabled())if(e.rebootMode===r.NewDocument&&e.documentUrl){t.objectUrl=e.documentUrl,t.fileId=void 0;var i=this.filesUtilityService.getFileNameFromObjectURL(t.objectUrl),n=i?this.utilityService.getFileExtension(i):void 0;t.fileType=this.isWXPExtension(n)?n:this.fileType,t.shareUrl=void 0,t.shareId=void 0,t.rebootOverrideData=this.getRebootOverrideData(e),t.wacScenario=e.reason?e.reason:this.constants.wacScenario.rebootMRU}else e.rebootMode===r.SameDocument&&(t.rebootOverrideData=this.getRebootOverrideData(e),t.wacScenario=e.reason?e.reason:this.constants.wacScenario.rebootSameDoc);var o=s(s({},t),{reboot:!0});this.filesDocStageHelperService.changeFileNameInTeamsChromeHeader(!1);var a={documentViewerParams:o,viewerState:this.constants.states.appDocumentViewer};this.navigationService.navigateToFileViewer(a)}else this.userClickTime=void 0},e.prototype.getRebootOverrideData=function(e){return JSON.stringify({previousSessionId:e.previousSessionId,mode:e.mode,reason:e.reason,queryOverrides:e.queryOverrides,isNewSession:e.isNewSession})},e.prototype.getWacScenarioFromRouteParams=function(){return this.routeUtilityService.getRootRouteParams().wacScenario},e.prototype.getWacSessionOrigin=function(){var e=(this.useWebview?this.constants.wacSessionOriginApp.teamsElectron:this.constants.wacSessionOriginApp.teamsWeb)+"."+this.serviceName+"."+this.ctx,t=this.getWacScenarioFromRouteParams();return t&&(e+="-"+t),e},e}();t.FileUnifiedAppViewerController=a,angular.module("teamspace.fileUnifiedAppViewer",["teamspace.layoutService","teamspace.settingsService","teamspace.constants","teamspace.loggingService","teamspace.utilityService","teamspace.filesUtilityService","teamspace.routeUtilityService","teamspace.filesDocStageHelperService","teamspace.channelService","teamspace.filesMessagePaneHelper","teamspace.messageService","teamspace.storageService","teamspace.routeChangeService","teamspace.navigationService","teamspace.filesExternalLinksService","teamspace.desktopUtilityService","teamspace.filesRedeemService"]).component("fileUnifiedAppViewer",{bindings:{fileType:"<",objectUrl:"<",scenario:"<",hideClose:"<?",onClose:"&?",userClickTime:"<",ctx:"<",redeemPromise:"<",driveItemCallStartTime:"<",displayTitleBar:"=",isEditMode:"=",moreOptions:"<?",hideSpinner:"<?",fileName:"<",serviceName:"<",threadId:"<",fileId:"<",moveEditInBrowserFromMoreOptions:"<"},template:n,controller:a})},2750:function(e,t){e.exports='<div id="file-unified-app-viewer" class="flex-fill" ng-focus="$ctrl.handleFocus($event)" tabindex="0">\n\n  <file-full-alert class="flex-fill" error="$ctrl.fileErrorCode" ng-if="$ctrl.fileErrorCode" allow-download="$ctrl.allowDownloadOnError" entity-context="::$ctrl.entityContext">\n  </file-full-alert>\n\n  <div ng-if="!$ctrl.fileErrorCode" class="flex-fill">\n    <iframe id="file-unified-app-viewer-frame" ng-if="::!$ctrl.useWebview" ng-src="{{$ctrl.fileViewerExpUrl}}" class="wopi-iframe flex-fill" frameborder="0" role="presentation" tabindex="-1" aria-hidden="true">\n    </iframe>\n\n    <webview id="file-unified-app-viewer-webview" ng-if="::$ctrl.useWebview" ng-src="{{$ctrl.fileViewerExpUrl}}" class="wopi-iframe flex-fill" frameborder="0" role="presentation" tabindex="-1" aria-hidden="true">\n    </webview>\n  </div>\n</div>\n<div class="ts-right-rail thread-right-rail file-unified-app-viewer-conversation-panel" ng-if="$ctrl.isConversationPanelOpen">\n  <div class="file-unified-app-viewer-conversation-panel-container">\n    <div class="ts-canvas-message-pane">\n      <div class="conversation-title-bar">\n        <button class="ts-sym app-icons-fill-hover conversation-close" aria-label="{{::$root.resources.strings.files_conversation_chat_pane_close_button_aria_label| translate:{fileName:$ctrl.fileName} }}" title="{{::$root.resources.strings.files_conversation_chat_pane_close_button_tooltip | translate}}" ng-click="$ctrl.closeConversationPane()" acc-role="tab-handler-close-conversation-pane" tabindex="-1">\n          <ng-include class="icon icons-close" src="\'svg/icons-close.html\'"></ng-include>\n        </button>\n      </div>\n      <div class="file-unified-app-viewer-conversation-panel-container-body">\n        <img ng-src="[[staticsPath]]/hashed/placeholders/zero_chat-8cef77f.svg" class="files-zero-chat-icon"/>\n        <h4 class="file-empty-header-text">{{$ctrl.filesConversationEmptChatPaneHeader}}</h4>\n        <h5 class="file-empty-body-text">{{$ctrl.filesConversationEmptChatPaneBody}}</h5>\n        <div class="ts-files-start-conversation">\n          <div class="message-expander">\n            <div class="ts-files-add-message" id="add-new-message" data-tid="channelNewMessageContainer" ng-disabled="!$ctrl.canPostConversation">\n              <new-message send-message="$ctrl.initiateConversation(messageData, scenario)" message-type="::$ctrl.messageType" hide-people-picker="false" conversation-id="::$ctrl.threadId">\n              </new-message>\n            </div>\n          </div>\n        </div>\n      </div>\n    </div>\n  </div>\n</div>'},2751:function(e,t,i){"use strict";var s=this&&this.__assign||function(){return(s=Object.assign||function(e){for(var t,i=1,s=arguments.length;i<s;i++){t=arguments[i];for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])}return e}).apply(this,arguments)};Object.defineProperty(t,"__esModule",{value:!0});var r=i(2752),n=i(2753),o=function(){function e(e,t,i,s,r,n,o,a,l,c,d,h,p,f,u,v,m,g,y,w,S){var b=this;this.$scope=e,this.$window=i,this.$q=s,this.$timeout=n,this.constants=o,this.loggingService=a,this.settingsService=l,this.utilityService=c,this.authenticationService=d,this.filesSharedChannelAuthenticationService=h,this.appConfig=p,this.eventingService=f,this.filesActionService=v,this.filesUtilityService=m,this.appStateService=g,this.sharepointShareService=y,this.layoutService=w,this.desktopUtilityService=S,this.postMessageId="teams",this.clientId="MicrosoftTeams",this.oneupHeader="[OneDrive:From:Embed:"+this.postMessageId+"]",this.webViewElement=null,this.loadingComplete=!0,this.encounteredRedirectError=!1,this.logger=a.newLogger("FileViewer"),this.initialActiveElement=document.getElementById("file-office-frame-container")||window,this.isDesktopApp=l.valueAsBoolean(o.settings.names.isDesktopApp);var I=!1,C=!1,U=!1;i&&i.desktopSettings&&(I=i.desktopSettings.enableWebviewPreload,C=i.desktopSettings.enableWebviewSandbox,U=i.desktopSettings.enableTabWebviews),e.triggerFileDisplay=function(){return b.initFrame()},this.useWebView=l.valueAsBoolean(o.settings.names.filesEnableOneUpWebview)&&this.isDesktopApp&&!!i.electronSafeIpc&&(I&&C||U),this.oneUpServiceUrl=t.trustAsResourceUrl(this.getOneUpServiceUrl()),this.webViewSrc="",this.host=c.parseUrl(r.absUrl()).origin,this.currentLocale=u.getLocale(),e.$on("$destroy",function(){b.removeListeners(),b.scenario.cancel()}),this.mandatoryPropertyMissingOrPreviewNotAvailable()||(this.useWebView&&this.initWebView(),this.ensureInitialFocusIsNotStolen())}return e.$inject=["$scope","$sce","$window","$q","$location","$timeout","constants","loggingService","settingsService","utilityService","authenticationService","filesSharedChannelAuthenticationService","appConfig","eventingService","localizationService","filesActionService","filesUtilityService","appStateService","sharepointShareService","layoutService","desktopUtilityService"],e.prototype.initWebView=function(){var e=this,t=this.$window.electronSafeIpc;t&&this.useWebView&&(t.send(this.constants.events.desktopApp.allowWebViewCreate,{enablePreload:!0}),t.once(this.constants.events.desktopApp.webViewCreationEnabled,function(t,i){e.webViewElement=window.document.getElementById("file-one-up-viewer-webview"),e.desktopUtilityService.stampWebviewInstanceIdInWebPreferences(e.webViewElement,i),e.messageSource=e.webViewElement;e.addListener("ipc-message",function(t){return e.webviewProcessMessage(t)});e.addListener("crashed",function(t){return e.loggingService.event(e.constants.telemetry.webview.crashed,{errorEvent:JSON.stringify(t)})});e.addListener("gpu-crashed",function(t){return e.loggingService.event(e.constants.telemetry.webview.gpuCrashed,{errorEvent:JSON.stringify(t)})});e.addListener("plugin-crashed",function(t){return e.loggingService.event(e.constants.telemetry.webview.pluginCrashed,{errorEvent:JSON.stringify(t)})});e.addListener("did-fail-load",function(t){e.loggingService.event(e.constants.telemetry.webview.loadFailed,{errorEvent:JSON.stringify({errorCode:t?t.errorCode:null,errorDescription:t?t.errorDescription:null})}),e.logger.error("loading failed - did-fail-load fired",t.errorCode,t.errorDescription)});e.addListener("did-finish-load",function(t){return e.scenario.eventData=s(s({},e.scenario.eventData),{frameLoaded:!0})});var r=e.layout.bind(e);e.addListener("dom-ready",r),e.$window.addEventListener("resize",r),e.$scope.$on("$destroy",function(){e.$window.removeEventListener("resize",r)}),e.webViewSrc="iframe-container.html#iframeurl=about:blank&processTag="+e.constants.files.strings.oneup}))},e.prototype.layout=function(){if(this.webViewElement&&this.$window.electronSafeIpc){this.uuid||(this.uuid=this.utilityService.generateUUID());var e=this.webViewElement.clientWidth,t=this.webViewElement.clientHeight;this.$window.electronSafeIpc.send(this.constants.events.desktopApp.webViewResize,{width:e,height:t,uuid:this.uuid})}},e.prototype.addListener=function(e,t){this.webViewElement?this.webViewElement.addEventListener(e,t):window.addEventListener(e,t),this.listeners||(this.listeners={}),this.listeners[e]=t},e.prototype.removeListeners=function(){for(var e in this.listeners)this.webViewElement?this.webViewElement.removeEventListener(e,this.listeners[e]):window.removeEventListener(e,this.listeners[e]);this.listeners=null},e.prototype.webviewProcessMessage=function(e){if((e&&e.channel)===this.constants.webViewShim.postMessageFromWebview){var t=e.srcElement||e.target;if(this.webViewElement===t)if(!e.args||e.args.length<2)this.logger.error("OneUp viewer did not receive all the params");else{var i=e.args&&e.args[0];window&&window.location&&window.location.origin===i?this.handlePostMessageFromContainer(e.args[1]):this.oneUpServiceOrigin===i?this.handlePostMessage({origin:e.args[0],data:e.args[1],source:this.webViewElement}):this.logger.error("invalid event origin {0}",i)}else this.logger.error("OneUp viewer received message from a different webview")}},e.prototype.handlePostMessageFromContainer=function(e){if(e&&e.func){if("iframeLoaded"===e.func)return void this.postFormToWebview();if("error"===e.func)return void this.handleCurrentWindowErrorMessage(e)}},e.prototype.postFormToWebview=function(){var e=this;this.getAuthToken().then(function(t){e.embedParams=e.getEmbedParams(t),e.oneUpServiceOrigin=e.utilityService.parseUrl(e.oneUpServiceUrl).origin,e.encounteredRedirectError=!1,e.webViewElement.send(e.constants.webViewShim.postFormToWebview,{url:e.getOneUpServiceUrl(),params:{context:e.embedParams}})})},e.prototype.handleCurrentWindowErrorMessage=function(e){var t="";try{t=JSON.stringify(e.args)}catch(e){t=e.toString()}this.logger.error("received errorCode: {0}, errorMessage {1} for oneup viewer","IPC error",t),this.handleError("IPC error",t)},e.prototype.initFrame=function(){var e=this;this.scenario.eventData=s(s({},this.scenario.eventData),{frameLoaded:!0}),this.encounteredRedirectError=!1,this.getAuthToken().then(function(t){var i=document.getElementById("file-one-up-viewer-frame"),s=document.getElementById("file-one-up-viewer-form"),r=document.getElementById("file-one-up-viewer-context");e.messageSource=i.contentWindow,e.embedParams=e.getEmbedParams(t);try{r.value=JSON.stringify(e.embedParams)}catch(t){e.logger.error("Exception in stringfying embed params correlationId {0} ",e.embedParams.correlationId),e.errorCode=e.constants.files.error.invalidArguments}e.registerPostMessageHandler(),s.submit()})},e.prototype.getEmbedParams=function(e){var t={id:this.postMessageId,o:this.host,ct:(new Date).getTime(),tp:!0},i=this.getOneUpThemePayload();return{authToken:e,webUrl:this.siteUrl,UniqueId:this.fileId&&this.fileId.replace(/{|}/g,""),id:this.serverRelativeUrl,embed:JSON.stringify(t),culture:this.currentLocale,client_id:this.clientId,correlationId:this.loggingService.sessionId+"-"+this.scenario.id,useHostDownload:!0,theme:i,item:this.driveItem,pageContextInfo:this.pageContextInfo}},e.prototype.isVideoFile=function(e){return-1!==this.settingsService.valueFor(this.constants.files.strings.oneUpSupportedVideoFiles).indexOf(e.toLowerCase())},e.prototype.getOneUpThemePayload=function(){var e,t=this.settingsService.getActiveTheme();if(this.settingsService.valueAsBoolean(this.constants.settings.names.enableFilesOneUpThemeFromTeams)){switch(t){case this.constants.themes.default:e=n.Themes.DefaultTheme;break;case this.constants.themes.dark:e=n.Themes.DarkTheme;break;case this.constants.themes.highContrast:e=n.Themes.HighContrastTheme;break;default:e=n.Themes.DefaultTheme}return e}var i={themePrimary:"#6264a7",themeDark:"#293370"},s={buttonTextHovered:"#fff",buttonTextPressed:"#fff"};return t===this.constants.themes.highContrast&&(i.themePrimary="#000",i.themeDark="#ffff01",i.neutralLighter="#fff",s.buttonTextHovered="#252424",s.buttonTextPressed="#252424"),e={palette:i,semanticColors:s}},e.prototype.getOneUpServiceUrl=function(){var e=this.appConfig.oneUpServiceConstants.host,t=new URL(e),i=this.appConfig.oneUpServiceConstants.devHost;return i&&t.searchParams.append("devHost",i),this.scenario.eventData.videoUseCdnTeam=!1,this.isVideoFile(this.type)&&this.settingsService.valueAsBoolean(this.constants.settings.names.enableCDNSupportForVideoFilesInOneUp)&&(t.searchParams.append("videoUseCdnTeam","true"),this.scenario.eventData.videoUseCdnTeam=!0),e=t.toString()},e.prototype.getAuthToken=function(e){var t=this;this.extractSiteUrlIfNotPresent();var i=this.utilityService.parseUrl(this.siteUrl).origin;return this.filesUtilityService.updateTokenWarmingRule(i),this.filesSharedChannelAuthenticationService.getSharedChannelAuthenticationInfo(i).then(function(s){var r=s&&s.userIdentifier,n=s&&s.silent;return t.authenticationService.getAuthTokens([i],e?[e]:void 0,n,r).catch(function(e){t.logger.error("Failed fetching the AuthToken. Error: {0}",e);var i=e===t.constants.events.appState.reasons.resourceDisabled;return i?t.handleError(t.constants.files.error.invalidResource,"Invalid SPO Object URL",void 0,i):t.handleError(""+t.constants.responseCode.unauthorizedAccess,t.constants.files.error.unauthorizedAccessException),t.fileErrorCode=t.constants.files.error.unknown,t.$q.reject(e)})})},e.prototype.registerPostMessageHandler=function(){var e=this;this.removeListeners();this.addListener("message",function(t){return e.handlePostMessage(t.originalEvent||t)})},e.prototype.handlePostMessage=function(e){var t=this,i=e,s=this.utilityService.parseUrl(this.oneUpServiceUrl).origin;if(i&&i.origin&&i.origin.toLowerCase()===s.toLowerCase()&&i.source===this.messageSource&&_.startsWith(i.data,this.oneupHeader)){var r=i.data.substr(this.oneupHeader.length),n=JSON.parse(r||"{}");switch(n.type){case"success":var o=n;this.logger.info("success callback from oneUp {0}",o),this.stopScenario(o.previewType,o.conversationId);break;case"error":var a=n,l=a.error?a.error.code:this.constants.files.error.unknownOneUp,c=a.error?a.error.message:this.constants.files.error.unknownOneUp,d=this.settingsService.valueAsBoolean(this.constants.settings.names.enableRetryOnRedirectErrorForOneUp);this.logger.info("error callback from oneUp {0}",a),d&&n&&"RedirectError"===n.data?(this.scenario.eventData.specialCase=this.constants.errorCodes.invalidAudienceUri,this.encounteredRedirectError=!0,this.reloadFileOnRedirectError(a.conversationId)):!this.encounteredRedirectError&&this.handleError(l,c,a.conversationId,a.isExpected);break;case"download":if(this.serviceName&&this.fileDetail){var h={serviceName:this.serviceName,getContextBase:function(){return t.filesUtilityService.getContextBase(t.fileDetail,t.serviceName,void 0,t.fileDetail.objectUrl,!1)}};this.filesActionService.execute(teamspace.services.EntityActionType.Download,this.fileDetail,h)}else this.loggingService.error("oneUp download failed because fileDetail or serviceName undefined for scenario "+this.scenario.id);break;case"focusKeyInput":this.layoutService.navigateToNextLandmark(!0);break;case"getToken":var p=n,f=p.options,u=f&&f.claimsChallenge&&f.claimsChallenge.claims;this.getAuthToken(u).then(function(e){t.postTokenToOneUp(i.source,p.conversationId,e)}).catch(function(e){t.logger.error("error to fetch ssm/llt token"),t.postTokenToOneUp(i.source,p.conversationId,null,e)})}i.source&&void 0!==n.conversationId&&this.postAckMessage(i.source,n.conversationId)}},e.prototype.reloadFileOnRedirectError=function(e){var t=this;this.scenario.mark("get_updated_site_url_start"),this.sharepointShareService.getSiteResourceInfo(this.siteUrl).then(function(i){t.scenario.mark("get_updated_site_url_end"),i!==t.siteUrl?(t.updateOneUpParams(i),t.useWebView?t.postFormToWebview():t.initFrame()):(t.scenario.mark("updated_site_unchanged"),t.scenario.eventData.specialCase=null,t.handleError(t.constants.errorCodes.invalidMultiGeoCase,"Retry not needed. Not true multi geo case",e,!1))}).catch(function(i){t.scenario.mark("get_updated_site_url_fail"),t.handleError("GRAPH_"+(i.statusCode||i.errorCode),i.errorMessage,e,!0)})},e.prototype.updateOneUpParams=function(e){this.siteUrl=e;var t=this.utilityService.parseUrl(this.siteUrl).origin,i=this.utilityService.parseUrl(this.objectUrl).pathname;this.fileDetail=s(s({},this.fileDetail),{siteUrl:e,objectUrl:""+t+i})},e.prototype.postAckMessage=function(e,t){if(e){var i={type:"acknowledge",conversationId:t},s=this.oneupHeader+JSON.stringify(i);this.sendMassageToOneUpFrame(e,s)}},e.prototype.postTokenToOneUp=function(e,t,i,s){if(e){var r,n;n=i?{type:"result",conversationId:t,data:{result:"success",token:i}}:{type:"result",conversationId:t,data:{result:"error",isExpected:!1,error:{code:s&&(s.code||s.errorCode||s.statusCode),message:s&&(s.message||s.errorMessage)}}},r=this.oneupHeader+JSON.stringify(n),this.sendMassageToOneUpFrame(e,r)}else this.logger.error("invalid source")},e.prototype.sendMassageToOneUpFrame=function(e,t){if(this.useWebView&&this.webViewElement)this.webViewElement.send(this.constants.webViewShim.postMessageToWebview,t);else{var i=this.utilityService.parseUrl(this.oneUpServiceUrl).origin;e.postMessage(t,i)}},e.prototype.stopScenario=function(e,t){this.loadingComplete=!0,this.eventingService.$emit(this.constants.events.files.fileOneUpViewerLoaded,{conversationId:t,previewType:e,useWebview:this.getUseWebViewFlag(),scenario:this.scenario})},e.prototype.mandatoryPropertyMissingOrPreviewNotAvailable=function(){if(this.extractSiteUrlIfNotPresent(),!this.siteUrl||!this.serverRelativeUrl&&!this.fileId){e=this.siteUrl?"Invalid ServerRelativeURL and FileId":"Invalid SiteURL";return this.logger.error(e),this.errorCode=this.constants.files.error.invalidArguments,this.handleError(this.errorCode,e),!0}if(this.previewAvailable=this.filesUtilityService.isOneUpSupportedFile(this.type),!this.previewAvailable){this.fileErrorCode=this.constants.errorCodes.previewNotAvailable,this.entityContext={id:this.fileId,objectUrl:this.objectUrl,serviceName:this.serviceName,title:this.fileDetail.title};var e="File Preview not available";return this.handleError(this.fileErrorCode,e,null,!0),!0}return!1},e.prototype.handleError=function(e,t,i,s){this.loadingComplete=!0,(!this.appStateService.isOnline||!this.appStateService.isConnected)&&(e=this.fileErrorCode=this.constants.errorCodes.networkOffline,t="Network is offline",s=!0),s||this.checkIfExpectedFailure(e)?this.scenario.incomplete({errorCode:e,errorMessage:t,conversationId:i,useWebview:this.getUseWebViewFlag(),isExpectedFailure:this.constants.files.isExpectedFailure.yes}):this.scenario.fail({errorCode:e,errorMessage:t,conversationId:i,useWebview:this.getUseWebViewFlag()})},e.prototype.checkIfExpectedFailure=function(e){var t=this.constants.responseCode;return-1!==[t.unauthorizedAccess,t.forbidden,t.notFound,t.notAcceptable].indexOf(Number(e))},e.prototype.getUseWebViewFlag=function(){return this.useWebView?"true":"false"},e.prototype.ensureInitialFocusIsNotStolen=function(){var e=this,t=angular.element(this.$window);this.onWindowBlur&&(t.unbind(this.constants.events.jQuery.blur,this.onWindowBlur),this.onWindowBlurDestroyHandler()),this.onWindowBlur=function(t){return e.onWindowBlurHandler(t)},t.on(this.constants.events.jQuery.blur,this.onWindowBlur),this.onWindowBlurDestroyHandler=this.$scope.$on("$destroy",function(){t.unbind(e.constants.events.jQuery.blur,e.onWindowBlur)})},e.prototype.onWindowBlurHandler=function(e){var t=this;angular.element(this.$window).unbind(this.constants.events.jQuery.blur,this.onWindowBlur),this.onWindowBlurDestroyHandler(),this.onWindowBlur=null,this.$timeout(function(){return angular.element(t.initialActiveElement).focus()},100,!1)},e.prototype.extractSiteUrlIfNotPresent=function(){this.objectUrl&&!this.siteUrl&&(this.siteUrl=this.filesUtilityService.extractSiteUrl(this.objectUrl))},e}();angular.module("teamspace.fileOneUpViewer",["teamspace.settingsService","teamspace.utilityService","teamspace.authenticationService","teamspace.filesSharedChannelAuthenticationService","teamspace.desktopUtilityService"]).component("fileOneUpViewer",{bindings:{scenario:"<",type:"<",siteUrl:"<",serverRelativeUrl:"<",fileDetail:"<",serviceName:"<",driveItem:"<",fileId:"<",objectUrl:"<",pageContextInfo:"<"},template:r,controller:o}).directive("oneUpIframe",function(){return{restrict:"A",link:function(e,t){var i=!1;t.on("load",function(){i||(i=!0,e.triggerFileDisplay())})}}})},2752:function(e,t){e.exports='<div id="file-one-up-viewer" class="flex-fill">\n\n  <div ng-if="!$ctrl.loadingComplete">\n      <busy-animation size="medium" context="file-one-up-viewer">\n      </busy-animation>\n  </div>\n\n  <file-full-alert class="flex-fill" object-url="{{$ctrl.objectUrl}}" error="$ctrl.fileErrorCode" ng-if="$ctrl.fileErrorCode" entity-context="::$ctrl.entityContext">\n  </file-full-alert>\n\n  <div ng-style="{\'visibility\' : $ctrl.loadingComplete ? \'visible\' : \'hidden\'}" ng-if="!$ctrl.fileErrorCode" class="flex-fill">\n    <form id="file-one-up-viewer-form" target="file-one-up-viewer-frame" method="POST" action="{{$ctrl.oneUpServiceUrl}}" hidden>\n      <input id="file-one-up-viewer-context" type="text" name="context"/>\n      <input type="submit"/>\n    </form>\n\n    <iframe one-up-iframe id="file-one-up-viewer-frame" name="file-one-up-viewer-frame" ng-if="::!$ctrl.useWebView" ng-src="about:blank" sandbox="allow-forms allow-popups allow-pointer-lock allow-same-origin allow-scripts" class="wopi-iframe flex-fill" frameborder="0" role="presentation" tabindex="0" aria-hidden="true">\n    </iframe>\n\n    <webview id="file-one-up-viewer-webview" ng-if="::$ctrl.useWebView" ng-src="{{$ctrl.webViewSrc}}" class="wopi-iframe flex-fill" frameborder="0" role="presentation" tabindex="0" aria-hidden="true">\n    </webview>\n  </div>\n</div>\n'},2753:function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var s={palette:{themePrimary:"#6264a7",themeLighterAlt:"#f4f4f9",themeLighter:"#e3e3ef",themeLight:"#babbd8",themeTertiary:"#898bbc",themeSecondary:"#696baa",themeDarkAlt:"#464775",themeDark:"#3d3f6c",themeDarker:"#34365c",neutralLighterAlt:"#faf9f8",neutralLighter:"#f3f2f1",neutralLight:"#edebe9",neutralQuaternaryAlt:"#e1dfdd",neutralQuaternary:"#d0d0d0",neutralTertiaryAlt:"#c8c6c4",neutralTertiary:"#a19f9d",neutralSecondaryAlt:"#8a8886",neutralSecondary:"#605e5c",neutralPrimary:"#323130",neutralPrimaryAlt:"#3b3a39",neutralDark:"#201f1e",black:"#000000",white:"#ffffff",redDark:"#a4262c",primaryBackground:"#1b1a19",primaryText:"#f3f2f1",whiteTranslucent40:"rgba(0,0,0,.5)",freOverlayColor:"rgba(0,0,0,.5)",shareSuccessIcon:"#92C353",wordColor:"#296FE6",powerpointColor:"#CA5010",excelColor:"#10893C",excelPrimaryColor:"#10893C",excelShade10Color:"#0F7937",excelShade20Color:"#0A5325",powerpointPrimaryColor:"#CA5010",powerpointShade10Color:"#B1470E",powerpointShade20Color:"#79310A",wordPrimaryColor:"#296FE6",wordShade10Color:"#2461CA",wordShade20Color:"#19428A",wordIconColor:"#598FEC",powerpointIconColor:"#D67540",excelIconColor:"#37A660",visoIconColor:"#598FEC",oneNoteIconColor:"#D0AFE2",oneUpPaneBackground:"rgba(27, 26, 25, .75)"},semanticColors:{bodyBackground:"#ffffff",bodyStandoutBackground:"#faf9f8",buttonText:"#323130",buttonTextPressed:"#201f1e",buttonTextHovered:"#201f1e",bodySubtext:"#605e5c",disabledBackground:"#f3f2f1",errorText:"#a4262c",inputBackgroundChecked:"#6264a7",menuBackground:"#ffffff",menuItemBackgroundHovered:"#f3f2f1",menuItemBackgroundPressed:"#edebe9",menuDivider:"#c8c6c4",menuIcon:"#0078D4",menuHeader:"#0078D4",menuItemText:"#323130",menuItemTextHovered:"#201f1e",messageText:"#323130",primaryButtonBackground:"#0078D4",primaryButtonBackgroundHovered:"#006cbe",primaryButtonBackgroundPressed:"#005ba1",primaryButtonText:"#ffffff",primaryButtonTextHovered:"#ffffff",primaryButtonTextPressed:"#ffffff",variantBorder:"#edebe9",infoBackground:"#f3f2f1",infoIcon:"#605e5c",errorIcon:"#A80000",warningIcon:"#797775",blockingIcon:"#FDE7E9",severeWarningIcon:"#D83B01",successIcon:"#107C10",errorBackground:"#FDE7E9",blockingBackground:"#FDE7E9",warningBackground:"#FFF4CE",severeWarningBackground:"#FED9CC",successBackground:"#DFF6DD"},isInverted:!1},r={palette:{themePrimary:"#6264a7",themeLighterAlt:"#07070c",themeLighter:"#11121e",themeLight:"#2a2b49",themeTertiary:"#48497e",themeSecondary:"#5b5ea1",themeDarkAlt:"#7274af",themeDark:"#9a9cc6",themeDarker:"#a9aace",neutralLighterAlt:"#201f1e",neutralLighter:"#252423",neutralLight:"#292827",neutralQuaternaryAlt:"#323130",neutralQuaternary:"#3b3a39",neutralTertiaryAlt:"#484644",neutralTertiary:"#797775",neutralSecondaryAlt:"#979693",neutralSecondary:"#a19f9d",neutralPrimary:"#f3f2f1",neutralPrimaryAlt:"#c8c6c4",neutralDark:"#faf9f8",black:"#ffffff",white:"#1b1a19",redDark:"#F1707B",primaryBackground:"#1b1a19",primaryText:"#f3f2f1",whiteTranslucent40:"rgba(0,0,0,.5)",freOverlayColor:"rgba(0,0,0,.5)",shareSuccessIcon:"#92C353",wordColor:"#296FE6",powerpointColor:"#CA5010",excelColor:"#10893C",excelPrimaryColor:"#10893C",excelShade10Color:"#0F7937",excelShade20Color:"#0A5325",powerpointPrimaryColor:"#CA5010",powerpointShade10Color:"#B1470E",powerpointShade20Color:"#79310A",wordPrimaryColor:"#296FE6",wordShade10Color:"#2461CA",wordShade20Color:"#19428A",wordIconColor:"#598FEC",powerpointIconColor:"#D67540",excelIconColor:"#37A660",visoIconColor:"#598FEC",oneNoteIconColor:"#D0AFE2",oneUpPaneBackground:"rgba(27, 26, 25, .75)"},semanticColors:{bodyBackground:"#1b1a19",bodyStandoutBackground:"#292827",buttonText:"#ffffff",buttonTextPressed:"#faf9f8",buttonTextHovered:"#f3f2f1",bodySubtext:"#a19f9d",disabledBackground:"#323130",errorText:"#F1707B",inputBackgroundChecked:"#6264a7",menuBackground:"#252423",menuItemBackgroundHovered:"#323130",menuItemBackgroundPressed:"#3b3a39",menuDivider:"#484644",menuIcon:"#3aa0f3",menuHeader:"#ffffff",menuItemText:"#f3f2f1",menuItemTextHovered:"#faf9f8",messageText:"#f3f2f1",primaryButtonBackground:"#0078D4",primaryButtonBackgroundHovered:"#004c87",primaryButtonBackgroundPressed:"#043862",primaryButtonText:"#ffffff",primaryButtonTextHovered:"#ffffff",primaryButtonTextPressed:"#ffffff",variantBorder:"#3b3a39",infoBackground:"#323130",infoIcon:"#c8c6c4",errorIcon:"#F1707B",warningIcon:"#c8c6c4",blockingIcon:"#442726",severeWarningIcon:"#FCE100",successIcon:"#92C353",errorBackground:"#442726",blockingBackground:"#442726",warningBackground:"#433519",severeWarningBackground:"#4F2A0F",successBackground:"#393D1B"},isInverted:!0},n={palette:{themePrimary:"#ffff01",themeLighterAlt:"#121200",themeLighter:"#2e2e00",themeLight:"#6f6f00",themeTertiary:"#c0c000",themeSecondary:"#f4f400",themeDarkAlt:"#ffff19",themeDark:"#ffff5c",themeDarker:"#ffff73",neutralLighterAlt:"#0b0b0b",neutralLighter:"#252423",neutralLight:"#292827",neutralQuaternaryAlt:"#323130",neutralQuaternary:"#3b3a39",neutralTertiaryAlt:"#484644",neutralTertiary:"#797775",neutralSecondaryAlt:"#979693",neutralSecondary:"#a19f9d",neutralPrimary:"#f3f2f1",neutralPrimaryAlt:"#c8c6c4",neutralDark:"#faf9f8",black:"#ffffff",white:"#1b1a19",redDark:"#F1707B",primaryBackground:"#1b1a19",primaryText:"#f3f2f1",whiteTranslucent40:"rgba(0,0,0,.5)",freOverlayColor:"rgba(0,0,0,.5)",shareSuccessIcon:"#92C353",wordColor:"#296FE6",powerpointColor:"#CA5010",excelColor:"#10893C",excelPrimaryColor:"#10893C",excelShade10Color:"#0F7937",excelShade20Color:"#0A5325",powerpointPrimaryColor:"#CA5010",powerpointShade10Color:"#B1470E",powerpointShade20Color:"#79310A",wordPrimaryColor:"#296FE6",wordShade10Color:"#2461CA",wordShade20Color:"#19428A",wordIconColor:"#598FEC",powerpointIconColor:"#D67540",excelIconColor:"#37A660",visoIconColor:"#598FEC",oneNoteIconColor:"#D0AFE2",oneUpPaneBackground:"rgba(27, 26, 25, .75)"},semanticColors:{bodyBackground:"#1b1a19",bodyStandoutBackground:"#292827",buttonText:"#ffffff",buttonTextPressed:"#faf9f8",buttonTextHovered:"#f3f2f1",bodySubtext:"#a19f9d",disabledBackground:"#323130",errorText:"#F1707B",inputBackgroundChecked:"#ffff01",menuBackground:"#252423",menuItemBackgroundHovered:"#323130",menuItemBackgroundPressed:"#3b3a39",menuDivider:"#484644",menuIcon:"#3aa0f3",menuHeader:"#ffffff",menuItemText:"#f3f2f1",menuItemTextHovered:"#faf9f8",messageText:"#f3f2f1",primaryButtonBackground:"#0078D4",primaryButtonBackgroundHovered:"#004c87",primaryButtonBackgroundPressed:"#043862",primaryButtonText:"#ffffff",primaryButtonTextHovered:"#ffffff",primaryButtonTextPressed:"#ffffff",variantBorder:"#3b3a39",infoBackground:"#323130",infoIcon:"#c8c6c4",errorIcon:"#F1707B",warningIcon:"#c8c6c4",blockingIcon:"#442726",severeWarningIcon:"#FCE100",successIcon:"#92C353",errorBackground:"#442726",blockingBackground:"#442726",warningBackground:"#433519",severeWarningBackground:"#4F2A0F",successBackground:"#393D1B"},isInverted:!0};t.Themes={DefaultTheme:s,DarkTheme:r,HighContrastTheme:n}},2754:function(e,t,i){"use strict";var s=this&&this.__assign||function(){return(s=Object.assign||function(e){for(var t,i=1,s=arguments.length;i<s;i++){t=arguments[i];for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])}return e}).apply(this,arguments)};Object.defineProperty(t,"__esModule",{value:!0});var r=i(2755),n=function(){function e(e,t,i,s,r,n,o,a,l,c,d,h,p,f,u,v,m,g,y,w,S,b,I,C,U){var E=this;this.$q=e,this.$scope=t,this.$state=i,this.$translate=s,this.constants=r,this.resources=n,this.loggingService=o,this.utilityService=a,this.routeUtilityService=l,this.filesEntityService=c,this.filesUtilityService=d,this.filesActionService=h,this.analyticsService=p,this.filesActionRouter=f,this.filesProviderFactory=u,this.settingsService=v,this.sharepointScenarioHandler=m,this.sharePointFilePreviewService=g,this.filesRedeemService=w,this.navigationService=S,this.filesDocStageHelperService=I,this.filesSharingHelper=C,this.fileViewErrorCodeSanitizerService=U,this.isPreProcessingComplete=void 0,this.useNStarViewerExpInMainWindow=!1,this.displayTitleBar=!0,this.showSpinner=!0,this.isRenderListApiCallComplete=void 0,this.moveEditInBrowserFromMoreOptions=!1,this.scenarioComplete=!1,this.fileDetailsFetchSuccess=!1,this.logger=o.newLogger("FileViewer");var A=l.getRootRouteParams();this.ctx=A.ctx?decodeURIComponent(A.ctx):void 0,this.accessType=A.accessType;var T;!this.objectUrl||A.fileName&&this.fileType||(T=d.getFileNameFromObjectURL(this.objectUrl)),this.fileName=A.fileName?A.fileName:T,this.fileId=this.fileId&&this.fileId.replace(/{|}/g,""),!this.shareUrl&&A.shareUrl&&(this.shareUrl=A.shareUrl),!A.navId&&A.shareUrl&&(A.navId=this.getNavIdFromShareUrl(A.shareUrl)),!this.shareId&&A.shareId&&(this.shareId=A.shareId),C.shareLogInfo(r.files.actionLogs.fileOpen,this.fileId,this.shareUrl?"shareUrl exists":"shareUrl does not exist"),this.isNewFile=this.ctx===r.scenarios.files.newFileCreationContext||A.viewerAction===r.files.fileActions.viewer.editNew;var k=v.valueAsBoolean(r.settings.names.filesEnableSharePointFilePreviewService);i.current.name!==r.states.appDocumentViewer&&i.current.name!==r.states.appAppsAppFileSection||A.viewerAction!==r.files.fileActions.viewer.edit&&A.viewerAction!==r.files.fileActions.viewer.editNew?(this.viewerType=k?g.getPreviewerType(this.fileType):teamspace.services.files.modules.sharePoint.FilePreviewerTypes.Wac,this.wacEdit=!1):(this.viewerType=k?g.getEditorType(this.fileType):teamspace.services.files.modules.sharePoint.FilePreviewerTypes.Wac,this.wacEdit=!0);var P=this.getActionType();if(d.isNStarViewerExpInMainWindowEnabled(this.fileType)&&b.getBrowser()!==r.browser.ie&&(this.wacEdit=!a.isVisioFile(this.fileType)||P===r.wopiActions.edit,this.useNStarViewerExpInMainWindow=!0,d.isIntegratedUXEnabled(this.fileType)&&(this.displayTitleBar=P===r.wopiActions.view||!a.isVisioFile(this.fileType)&&!this.wacEdit),this.viewerType=teamspace.services.files.modules.sharePoint.FilePreviewerTypes.UnifiedApp,this.fileType===r.fileExtensions.email&&(this.viewerType=teamspace.services.files.modules.sharePoint.FilePreviewerTypes.Email,this.setFileDetails()),this.hideSpinner=function(){return E.showSpinner=!1}),y.$on(t,r.events.files.fileOneUpViewerLoaded,function(e,t){E.oneUpViewerLoadSucessMessage=t,E.stopScenario()}),this.useOneUp=this.viewerType===teamspace.services.files.modules.sharePoint.FilePreviewerTypes.OneUp,this.scenario=o.findScenario(this.scenarioName),this.scenario||(o.warn("file-office-frame: could not find scenario"),this.scenario=o.newScenario(this.scenarioName,null,function(){E.scenarioComplete=!0},r.timeInMiliseconds.tenMinutes),this.scenario.eventData={type:this.fileType,entryPoint:this.ctx,serviceName:this.serviceName}),this.scenario.eventData.viewerType=this.viewerType,this.scenario.eventData.type=d.scrubUnknownFileExtensions(this.fileType),this.scenario.eventData.isShareUrlPresent=!!this.shareUrl,this.logger.info("sessionId {0} scenarioId {1} viewerType {2}",o.sessionId,this.scenario.id,this.viewerType),this.baseUrl||this.ctx==r.SdkMessageTypes.openFilePreview||(this.baseUrl=d.extractSiteUrl(this.objectUrl)),this.fileId&&!d.filterFileIdToLog(this.fileId)&&(this.scenario.mark("invalid-fileid"),this.fileId=void 0),this.useOneUp&&(this.oneUpParams={baseUrl:this.baseUrl,fileType:this.fileType,scenario:this.scenario,serverRelativeUrl:d.extractServerRelativeUrl(this.objectUrl)}),t.$on("$destroy",function(){E.scenarioComplete||E.scenario.cancel()}),this.sendPanelViewTelemetry(),this.logger.info("type {0} isOneUp {1} isUnified {2}",this.fileType,this.useOneUp,this.useNStarViewerExpInMainWindow),this.useOneUp&&!a.isDocumentType(this.fileType))return this.setFileDetails(),void this.redeemFile(this.viewerType,A,T,P,!1);this.useNStarViewerExpInMainWindow?this.redeemFile(this.viewerType,A,T,P,!1):this.redeemFile(this.viewerType,A,T,P)}return e.$inject=["$q","$scope","$state","$translate","constants","resources","loggingService","utilityService","routeUtilityService","filesEntityService","filesUtilityService","filesActionService","analyticsService","filesActionRouter","filesProviderFactory","settingsService","sharepointScenarioHandler","sharePointFilePreviewService","eventingService","filesRedeemService","navigationService","platformDetectService","filesDocStageHelperService","filesSharingHelper","fileViewErrorCodeSanitizerService"],e.prototype.sendPanelViewTelemetry=function(){var e=this;this.analyticsService.onPanelView(this.$scope,{panel:{type:teamspace.PanelType.documentStage},dataBag:{fileId:this.fileId,fileExtension:this.filesUtilityService.scrubUnknownFileExtensions(this.fileType),serviceName:this.serviceName,context:this.ctx,viewerType:this.viewerType,fileIdNew:function(t){return e.filesUtilityService.filterFileIdToLog(t)}(this.fileId)}})},e.prototype.getNavIdFromShareUrl=function(e){var t=this.utilityService.getQueryParameters(e);return t?t.nav:null},e.prototype.getActionType=function(){if(this.isNewFile)return this.constants.wopiActions.editNew;var e=this.utilityService.getIconClass({type:this.fileType}),t=this.settingsService.valueAsBoolean(this.constants.settings.names.enableDefaultToROViewUnifiedAppWord);switch(e){case this.constants.css.fileIcons.word:return t?this.constants.wopiActions.view:this.constants.wopiActions.open;case this.constants.css.fileIcons.excel:return this.constants.wopiActions.open;case this.constants.css.fileIcons.powerpoint:return this.constants.wopiActions.edit;case this.constants.css.fileIcons.visio:return this.wacEdit?this.constants.wopiActions.edit:this.constants.wopiActions.open;case this.constants.css.fileIcons.onenote:return this.constants.wopiActions.edit;default:return}},e.prototype.redeemFile=function(e,t,i,s,r){var n=this;void 0===r&&(r=!0);var o=this.settingsService.valueAsBoolean(this.constants.settings.names.enableFetchPageContextInfoForOneUpViewer),a=this.useNStarViewerExpInMainWindow?teamspace.services.IFileRedeemScenario.NorthStarFileViewer:teamspace.services.IFileRedeemScenario.Thumbnail;if(this.logger.info("isDetailCallNeeded {0} isShareUrl {1} isNStarViewerExperience {2}",r,this.shareUrl,this.useNStarViewerExpInMainWindow),this.shareUrl||this.viewerType==teamspace.services.files.modules.sharePoint.FilePreviewerTypes.UnifiedApp){var l={fileId:this.fileId,shareId:this.shareId},c=this.settingsService.valueAsBoolean(this.constants.settings.names.enableInValidAudienceErrorRetryForUnifiedApps)&&(this.viewerType==teamspace.services.files.modules.sharePoint.FilePreviewerTypes.UnifiedApp||this.viewerType==teamspace.services.files.modules.sharePoint.FilePreviewerTypes.OneUp);if(this.settingsService.valueAsBoolean(this.constants.settings.names.enableBaseUrlValidationInFileViewer)&&!this.isValidBaseUrl()){var d={statusCode:400,message:"invalid baseUrl passed",errorCode:this.constants.files.fileViewErrorCodes.invalidRequest};return this.logger.error("invalid baseUrl passed"),void this.onFileLoadError(d,!1)}this.scenario.mark("redeem-call-started"),this.driveItemCallStartTime=Date.now();var h=this.settingsService.valueFor(this.constants.files.strings.oneUpServiceConstants).host,p=this.settingsService.valueFor(this.constants.files.strings.OneUpVideoServiceHostLink).host;o&&this.useOneUp&&this.viewerType==teamspace.services.files.modules.sharePoint.FilePreviewerTypes.OneUp&&h===p&&this.isMediaFileAndOneUpSupported()?(this.renderListDataAsStreamPromise=this.getRenderListDataAsStreamApiPromise(s,c),this.renderListDataAsStreamPromise.then(function(){n.isRenderListApiCallComplete=!0}).catch(function(e){n.isRenderListApiCallComplete=!1,n.onFileLoadError(e),n.scenario.fail(e)})):this.isRenderListApiCallComplete=!0,this.redeemPromise=this.filesRedeemService.redeemFile(this.objectUrl,this.shareUrl,a,s,l,this.baseUrl,c,this.scenario.name),this.redeemPromise.then(function(s){n.scenario.mark("redeem-call-finished"),n.driveItem=s,n.isPreProcessingComplete=!0,r&&n.fetchFileDetailsAndSetHeaders(e,t,i)}).catch(function(e){n.scenario.mark("redeem-call-failed"),n.onFileLoadError(e,!0)}).finally(function(){if(n.setFileDetails(),n.useNStarViewerExpInMainWindow){if(n.isPreProcessingComplete&&!n.isValidDriveItem(n.driveItem,n.fileType)){n.scenario.mark("redeem-call-incomplete");var e={statusCode:200,message:"jsAPI parameters missing in driveItem API response",errorCode:n.constants.files.fileViewErrorCodes.jsAPIParamsMissing};return n.logger.error("jsapi params missing in redeem call response"),void n.onFileLoadError(e,!0)}n.viewerType==teamspace.services.files.modules.sharePoint.FilePreviewerTypes.UnifiedApp&&n.isValidDriveItem(n.driveItem,n.fileType)&&fetch(n.driveItem.openWith.wac.bootstrapperUrl).then(function(e){var t=performance.getEntriesByName(n.driveItem.openWith.wac.bootstrapperUrl).slice(-1)[0],i=t?{latency:t.duration,cached:0===t.transferSize}:void 0;n.scenario.mark("JSAPI script prefetched",i)}).catch(function(e){n.scenario.mark("JSAPI prefetch failed")})}}),void 0!=this.renderListDataAsStreamPromise&&this.$q.all([this.redeemPromise,this.renderListDataAsStreamPromise]).then(function(e){})}else this.isPreProcessingComplete=!0,this.isRenderListApiCallComplete=!0,r&&this.fetchFileDetailsAndSetHeaders(e,t,i)},e.prototype.getRenderListDataAsStreamApiPromise=function(e,t){var i=this;if("getRenderListApiResponse"in this.filesRedeemService){this.renderListApiService=this.filesRedeemService;var s=this.objectUrl,r=this.fileDetail.serverRelativeUrl;this.fileDetail.serverRelativeUrl=this.filesUtilityService.extractServerRelativeUrl(s);var n={fileDetail:this.fileDetail,fetchPageContext:!0,fetchDriveItem:!1};this.scenario.mark("render-list-data-as-stream-api-call-started");var o=this.renderListApiService.getRenderListApiResponse(n,e,this.baseUrl,t,this.scenario.name);return o.then(function(e){i.pageContextInfo=e.PageContextInfo,i.isPreProcessingComplete||(i.fileDetail.serverRelativeUrl=r),i.scenario.mark("render-list-data-as-stream-api-call-finished")}).catch(function(e){throw i.isPreProcessingComplete||(i.fileDetail.serverRelativeUrl=r),i.scenario.mark("render-list-data-as-stream-api-call-failed"),i.logger.error("Unable to fetch page context info"),-1==e.statusCode?i.logger.error("Unable to initiate call to render list data as stream. Status code  = "+e.statusCode):404==e.statusCode?i.logger.error("Resource not found. Status Code = "+e.statusCode):i.logger.error("Call to RenderListDataAsStream api failed. Status Code = "+e.statusCode),e}),o}},e.prototype.isMediaFileAndOneUpSupported=function(){return 0==e.OneUpSupportedVideoFileExtensions.size&&this.settingsService.valueFor(this.constants.files.strings.oneUpSupportedVideoFileExtensions).forEach(function(t){e.OneUpSupportedVideoFileExtensions.set(t.toLowerCase(),!0)}),!!e.OneUpSupportedVideoFileExtensions.has(this.fileType.toLowerCase())},e.prototype.isValidBaseUrl=function(){return!/(_api\/web\/GetFileByServerRelativeUrl\()/i.test(this.baseUrl)},e.prototype.isValidDriveItem=function(e,t){return this.viewerType===teamspace.services.files.modules.sharePoint.FilePreviewerTypes.Email||!!(this.driveItem&&this.driveItem.openWith&&this.driveItem.openWith.wac)},e.prototype.fetchFileDetailsAndSetHeaders=function(e,t,i){var s,r=this,n=this.filesProviderFactory.create(teamspace.services.files.FilesProviderType.Sharepoint),o=this.filesActionRouter.getItemDetailsRepository(n),a=!0;(this.useNStarViewerExpInMainWindow||this.isNStarViewerType())&&(a=!1);var l=t.rootContext?decodeURIComponent(t.rootContext):void 0;if(this.getByFileIdAndBaseUrl(l)){var c=this.fileType?this.fileType:this.utilityService.getFileExtension(i);s=o.getById(this.baseUrl,this.fileId,c===this.constants.onenote.extension,this.isNewFile,a)}else s=this.objectUrl?o.getByUrl(this.objectUrl,a):this.$q.reject(teamspace.services.files.FilesError.createFromInternalError(this.constants.files.internalErrorCodes.common.argumentError,"File is not specified."));s.then(function(e){r.scenario.mark("details-call-finished"),r.fileDetail=e.value,r.fileDetail.size&&(r.scenario.eventData.size=r.utilityService.bytesToMb(r.fileDetail.size)),r.useOneUp||(r.wacUrl=r.wacEdit?r.fileDetail.wacUrlEdit:r.fileDetail.wacUrl),r.fileName||(r.fileName=r.fileDetail.title);var t=r.getSiteUrlFromFileDetails(r.fileDetail);if(t=decodeURIComponent(t),r.baseUrl!==t&&(r.baseUrl=t),r.useOneUp){if(!r.oneUpParams){var i=decodeURIComponent(r.fileDetail.objectUrl);r.oneUpParams={baseUrl:t,fileType:r.fileType,scenario:r.scenario,serverRelativeUrl:r.filesUtilityService.extractServerRelativeUrl(i)}}r.oneUpParams.fileDetail=r.fileDetail,r.oneUpParams.serviceName=r.serviceName}return r.fileDetail}).then(function(e){r.initializeTitleAndStopScenario()}).catch(function(e){r.logger.error("Error in details call"),r.onFileLoadError(e,!1,!0)})},e.prototype.setFileDetails=function(){var e=this.objectUrl;this.isPreProcessingComplete&&this.driveItem&&this.driveItem.webUrl&&(e=this.driveItem.webUrl),this.fileDetail={objectId:this.fileId,objectUrl:this.driveItem&&this.driveItem.webDavUrl?this.driveItem.webDavUrl:this.objectUrl,title:this.driveItem&&this.driveItem.name?this.driveItem.name:this.fileName,type:this.fileType,wacUrl:"",wacUrlEdit:"",openInWindowFileUrl:e,isPersonal:this.serviceName===this.constants.files.serviceName.personal,siteUrl:this.driveItem&&this.driveItem.sharepointIds&&this.driveItem.sharepointIds.siteUrl?this.driveItem.sharepointIds.siteUrl:this.baseUrl},this.oneUpParams&&(this.oneUpParams.fileDetail=this.fileDetail,this.oneUpParams.serviceName=this.serviceName,this.driveItem&&this.driveItem.webDavUrl&&this.objectUrl!==this.driveItem.webDavUrl&&(this.scenario.mark("oneup-params-updated-with-driveitem"),this.objectUrl=this.driveItem.webDavUrl,this.oneUpParams.baseUrl=this.filesUtilityService.extractSiteUrl(this.objectUrl),this.oneUpParams.serverRelativeUrl=this.filesUtilityService.extractServerRelativeUrl(this.objectUrl))),this.initializeTitleAndStopScenario()},e.prototype.initializeTitleAndStopScenario=function(){this._initializeTitleBar(),this.fileDetailsFetchSuccess=!0,this.stopScenario()},e.prototype.getByFileIdAndBaseUrl=function(e){return this.baseUrl&&this.fileId&&(e===this.constants.scenarios.files.itemsViewRootContext||this.fileType!==this.constants.onenote.extension)},e.prototype.getSiteUrlFromFileDetails=function(e){return e&&e.objectUrl||this.onFileLoadError({errorCode:void 0,internalErrorCode:""+this.constants.files.internalErrorCodes.common.invalidUrl,statusCode:200},!1,!0),e.siteUrl?e.siteUrl:(e.parentListUrl||this.onFileLoadError({errorCode:void 0,internalErrorCode:""+this.constants.files.internalErrorCodes.sharepoint.missingListUrl,statusCode:200},!1,!0),this.filesUtilityService.extractSiteUrl(e.objectUrl,e.parentListUrl))},e.prototype.stopScenario=function(){if(this.oneUpViewerLoadSucessMessage&&this.fileDetailsFetchSuccess&&this.oneUpParams&&this.oneUpParams.scenario&&this.oneUpViewerLoadSucessMessage.scenario===this.scenario){var e={conversationId:this.oneUpViewerLoadSucessMessage.conversationId,previewType:this.oneUpViewerLoadSucessMessage.previewType,useWebview:this.oneUpViewerLoadSucessMessage.useWebview};this.oneUpParams.scenario.stop(e)}},e.prototype._initializeTitleBar=function(){var e=this;if(this.fileDetail&&!this.isSPOUrlInvalid){var t={serviceName:this.serviceName,getContextBase:function(){return e.filesUtilityService.getContextBase(e.fileDetail,e.serviceName,void 0,e.fileDetail.objectUrl,!1)}},i=this.filesActionService.isReadOnlyNotTeamOwner({accessType:this.accessType,threadId:this.threadId}),r=this.filesEntityService.getOpenInText(this.fileDetail.type),n=this.settingsService.valueAsBoolean(this.constants.settings.names.filesEnableSharePointFilePreviewService),o=this.utilityService.getIconClass({type:this.fileType}),a=this.settingsService.valueAsBoolean(this.constants.settings.names.enableDefaultToROViewUnifiedAppWord),l=this.settingsService.valueAsBoolean(this.constants.settings.names.enableDirectDiscoveryOfEditInBrowser);if(this.moveEditInBrowserFromMoreOptions=o===this.constants.css.fileIcons.word&&a&&l,this.moveEditInBrowserFromMoreOptions)this.wacEdit=!1,this.editAction=function(){return e.filesActionService.execute(teamspace.services.EntityActionType.OpenInNewTab,e.fileDetail,s(s({},t),{isWordROAndOpenInBrowserEnabled:e.moveEditInBrowserFromMoreOptions}))},this.titleBarPrimaryOptions={primaryButtonText:this.$translate.instant(this.resources.strings.files_editButtonLabel),primaryButtonAria:this.$translate.instant(this.resources.strings.files_editButtonLabel)};else if(this.filesUtilityService.isVisioDesktopAppOnlyEditEnabled(this.fileDetail.type)){this.editAction=function(){return e.filesActionService.execute(teamspace.services.EntityActionType.OpenInDesktopApp,e.fileDetail,t)};var c=this.filesUtilityService.getProductLabels(this.fileDetail.type);this.titleBarPrimaryOptions={primaryButtonText:c.desktopProductName,primaryButtonAria:this.$translate.instant(this.resources.strings.files_editButtonAriaLabelVisio)}}else{var d=this.settingsService.valueAsBoolean(this.constants.settings.names.enableOfficeViewerEdit);d&&(this.editAction=function(){return e.changeToEdit()});var h=i?this.resources.strings.files_menuLabelOpenInTeams:this.resources.strings.files_menuLabelEditInTeams,p=d&&(!n||this.sharePointFilePreviewService.canEditFileInTeams(this.fileDetail.type)),f={id:"office-edit-in-teams",displayName:this.$translate.instant(h),class:"open-in-teams-entry",click:function(){return e.changeToEdit()},shouldBeHidden:function(){return!p},svgPath:"svg/icons-msft-teams.html"},u=n?this.sharePointFilePreviewService.canEditFileInDesktopApp(this.fileDetail.type)&&this.fileDetail.objectUrl:this.filesActionService.canUse(teamspace.services.EntityActionType.OpenInDesktopApp,this.fileDetail,{serviceName:this.serviceName}),v={id:"office-open-in-desktop-app",displayName:r.openInDesktopAppText,click:function(){return e.filesActionService.execute(teamspace.services.EntityActionType.OpenInDesktopApp,e.fileDetail,t)},shouldBeHidden:function(){return!u},svgPath:"svg/"+this.utilityService.getSVGBase(this.fileDetail.type,"icons-{type}")+".html"},m=n?this.sharePointFilePreviewService.canEditFileInSharePoint(this.fileDetail.type)&&this.fileDetail.openInWindowFileUrl:this.filesActionService.canUse(teamspace.services.EntityActionType.OpenInNewTab,this.fileDetail,{serviceName:this.serviceName});this.openInNewTabMenuItem={id:"office-open-in-new-tab",displayName:r.openInNewTabText,click:function(i,r,n,o,a){a?e.filesActionService.execute(teamspace.services.EntityActionType.OpenInNewTab,s(s({},e.fileDetail),{previousSessionId:a}),t):e.filesActionService.execute(teamspace.services.EntityActionType.OpenInNewTab,e.fileDetail,t)},shouldBeHidden:function(){return!m},svgPath:"svg/"+this.utilityService.getSVGBase(this.fileDetail.type,"icons-{type}")+".html"};var g=i?this.resources.strings.files_openButtonLabel:this.resources.strings.files_editButtonLabel;this.titleBarPrimaryOptions={primaryButtonText:this.$translate.instant(g),primaryButtonAria:this.$translate.instant(this.resources.strings.files_editButtonAriaLabel),dropdownButtonText:this.$translate.instant(this.resources.strings.files_moreEditOptionsButtonLabel),options:[f,v,this.openInNewTabMenuItem]}}this.titleBarMoreOptions=[{id:"download-office-document",displayName:this.$translate.instant(this.resources.strings.files_menuLabelDownload),click:function(){return e.filesActionService.execute(teamspace.services.EntityActionType.Download,e.getDownloadTarget(),t)},shouldBeHidden:function(){return!e.filesActionService.canUse(teamspace.services.EntityActionType.Download,e.fileDetail,{serviceName:e.serviceName})},svgPath:"svg/icons-download.html"},{id:"open-office-document-in-sharepoint",displayName:this.filesActionService.textFor(teamspace.services.EntityActionType.OpenInSharePoint,{serviceName:this.serviceName}),click:function(){return e.filesActionService.execute(teamspace.services.EntityActionType.OpenInSharePoint,e.fileDetail,null)},shouldBeHidden:function(){return!e.filesActionService.canUse(teamspace.services.EntityActionType.OpenInSharePoint,e.fileDetail,{serviceName:e.serviceName})},svgPath:"svg/"+this.filesActionService.iconFor(teamspace.services.EntityActionType.OpenInSharePoint,this.fileDetail,{serviceName:this.serviceName}).first+".html"},{id:"office-open-in-desktop-app",displayName:r.openInDesktopAppText,click:function(){return e.filesActionService.execute(teamspace.services.EntityActionType.OpenInDesktopApp,e.fileDetail,t)},shouldBeHidden:function(){return!e.filesActionService.canUse(teamspace.services.EntityActionType.OpenInDesktopApp,e.fileDetail,{serviceName:e.serviceName})||!e.moveEditInBrowserFromMoreOptions&&!e.wacEdit},svgPath:"svg/"+this.utilityService.getSVGBase(this.fileDetail.type,"icons-{type}")+".html"},{id:"office-open-in-new-tab",displayName:r.openInNewTabText,click:function(i,r,n,o,a){a?e.filesActionService.execute(teamspace.services.EntityActionType.OpenInNewTab,s(s({},e.fileDetail),{previousSessionId:a}),t):e.filesActionService.execute(teamspace.services.EntityActionType.OpenInNewTab,e.fileDetail,t)},shouldBeHidden:function(){return!e.filesActionService.canUse(teamspace.services.EntityActionType.OpenInNewTab,e.fileDetail,{serviceName:e.serviceName})||!!e.moveEditInBrowserFromMoreOptions||!e.wacEdit},svgPath:"svg/"+this.utilityService.getSVGBase(this.fileDetail.type,"icons-{type}")+".html"}],this.threadId&&(this.titleBarConversationInfo={threadId:this.threadId,objectId:this.fileDetail.objectId,serviceName:this.serviceName,objectUrl:this.fileDetail.objectUrl})}},e.prototype.getDownloadTarget=function(){return{objectId:this.fileId,title:this.driveItem&&this.driveItem.name?this.driveItem.name:this.fileName,objectUrl:this.driveItem&&this.driveItem.webDavUrl?this.driveItem.webDavUrl:this.objectUrl,serviceName:this.serviceName,shareUrl:this.shareUrl,shareId:this.shareId,siteUrl:this.driveItem&&this.driveItem.sharepointIds&&this.driveItem.sharepointIds.siteUrl?this.driveItem.sharepointIds.siteUrl:this.baseUrl}},e.prototype.getAccessibleIframeNotice=function(){if(this.openInNewTabMenuItem)return this.viewerType===teamspace.services.files.modules.sharePoint.FilePreviewerTypes.UnifiedApp?this.$translate.instant(this.resources.strings.files_accessible_iframe_notice):this.$translate.instant(this.resources.strings.files_inaccessible_iframe_notice)},e.prototype.openInNewTab=function(e){e.which===this.constants.keyCodes.enter&&e.target===e.currentTarget&&(-1!==this.settingsService.valueFor(this.constants.files.strings.oneUpSupportedVideoFiles).indexOf(this.fileType.toLowerCase())&&(this.fileDetail.openInWindowFileUrl=this.utilityService.appendQueryStringToUrl(this.fileDetail.openInWindowFileUrl,"web","1")),this.openInNewTabMenuItem.click(),e.preventDefault(),this.analyticsService.onPanelAction(this.$scope,{action:{gesture:teamspace.components.PanelActionGesture.click,scenario:teamspace.components.PanelActionScenario.openFile,scenarioType:teamspace.components.PanelActionScenarioType.files},module:{name:teamspace.shared.AttributeHelper.tryGetEnum(teamspace.components.PanelModuleName.documentStage.toString(),teamspace.components.PanelModuleName,this.loggingService).toString(),type:teamspace.components.PanelModuleType.viewer,summary:"Opening document from accessible iframe wrapper"},dataBag:{wacAccessibilityOpenOnline:!0}}))},e.prototype.changeToEdit=function(){var e=this;if(this.scenarioComplete||this.scenario.cancel({errorCode:"changeToEdit"}),this.scenarioComplete=!1,this.scenario=this.loggingService.newScenario(this.constants.scenarios.files.editFileFullScreen+"_"+this.serviceName,null,function(){e.scenarioComplete=!0}),this.scenario.eventData={type:this.fileType,entryPoint:this.ctx,serviceName:this.serviceName,viewerType:this.viewerType},this.$state.current.name==this.constants.states.appDocumentViewer){var t=this.routeUtilityService.getRootRouteParams();t.viewerAction=this.constants.files.fileActions.viewer.edit;var i={documentViewerParams:t,viewerState:this.constants.states.appDocumentViewer};this.navigationService.navigateToFileViewer(i,{location:"replace",notify:!1})}this.viewerType===teamspace.services.files.modules.sharePoint.FilePreviewerTypes.UnifiedApp?(this.filesDocStageHelperService.sendPostMessage({eventId:teamspace.services.ChildWindowEventRequest.FilesExperienceSendData,payload:{MessageId:"Host_SwitchMode",SendTime:Date.now(),Values:{NewMode:"edit"}}}),this.displayTitleBar=!1,this.filesDocStageHelperService.changeFileNameInTeamsChromeHeader(!0,this.fileName)):this.wacUrl=this.fileDetail.wacUrlEdit,this.wacEdit=!0,this.utilityService.isEditableVisioFileExtension(this.fileType)&&this.fileDetail.openInWindowFileUrl.includes("action=default")&&(this.fileDetail.openInWindowFileUrl=this.fileDetail.openInWindowFileUrl.replace("action=default","action=edit"))},e.prototype.onFileLoadError=function(e,t,i){void 0===t&&(t=!1),void 0===i&&(i=!1),this.isSPOUrlInvalid=this.checkForInvalidSPOUrl(e),this.isSPOUrlInvalid?this.fileErrorCode=this.constants.files.error.unknown:this.fileErrorCode=e&&(e.statusCode||e.errorCode||e.internalErrorCode||e.code)||this.constants.files.error.unknown;var s=_.get(e,"errorMessage.error");if(this.errorReasonForTelemetry=s&&s["error.errorMessage.error"],t||i){if(!e)return void this.scenario.fail({errorCode:"Unknown Error"});var r=e.errorMessage&&e.errorMessage.error,n=r&&r.innerError,o=e.errorCode||e.code||r&&r.code,a=r&&r.message;if(a=a||(e.message||e.internalErrorCode||this.errorReasonForTelemetry||this.fileErrorCode),this.scenario.eventData.SPRequestId||(this.scenario.eventData.SPRequestId=n&&n["request-id"]),o===this.constants.errorCodes.networkOffline)return void this.scenario.incomplete({errorCode:o,errorMessage:a});var l=e.statusCode;if(!l)return void this.scenario.fail({errorCode:o,errorMessage:a});if("number"!=typeof l){var c="type: "+typeof l+", status: "+l;return a=a?c+", message: "+a:c,void this.scenario.fail({statusCode:l,errorCode:o,errorMessage:a})}switch(o=this.fileViewErrorCodeSanitizerService.populateErrorCode(a,l,o),l){case this.constants.responseCode.clientFailure:case this.constants.responseCode.badRequest:case this.constants.responseCode.internalServerError:case this.constants.responseCode.serviceUnavailable:case this.constants.responseCode.ok:this.scenario.fail({statusCode:l,errorCode:o,errorMessage:a});break;default:this.scenario.incomplete({statusCode:l,errorMessage:a,errorCode:o})}}else if(this.scenario.mark("scenario-stop-pending"),this.filesSharingHelper.shareLogInfo(this.constants.files.actionLogs.fileOpenError,this.fileId,this.fileErrorCode,this.errorReasonForTelemetry),this.scenario){var d={errorCode:e&&(e.errorCode||e.internalErrorCode),statusCode:e&&e.statusCode};this.sharepointScenarioHandler.getFilesScenario(d,this.constants.files.scenarioActions.getFiles).finishScenario(this.scenario)}},e.prototype.checkForInvalidSPOUrl=function(e){return!!e&&(e===this.constants.events.appState.reasons.resourceDisabled||e.errorMessage===this.constants.events.appState.reasons.resourceDisabled||e.errorCode===this.constants.errorCodes.acquireTokenOtherError)},e.prototype.isNStarViewerType=function(){return this.viewerType===teamspace.services.files.modules.sharePoint.FilePreviewerTypes.UnifiedApp||this.viewerType===teamspace.services.files.modules.sharePoint.FilePreviewerTypes.Email},e.OneUpSupportedVideoFileExtensions=new Map,e}();angular.module("teamspace.fileOfficeFrame",["teamspace.loggingService","teamspace.utilityService","teamspace.routeUtilityService","teamspace.filesUtilityService","teamspace.filesActionService","teamspace.filesEntityService","teamspace.filesRedeemService","teamspace.analyticsService","teamspace.platformDetectService","teamspace.authenticationService","teamspace.services.files.modules.sharePoint.sharePointFileDetailsRepository","teamspace.services.files.modules.sharePoint.sharePointFilePreviewService","teamspace.services.files.modules.scenarios.sharepointScenarioHandler","teamspace.services.files.modules.sharePoint.vroom.sharepointShareService","teamspace.navigationService","teamspace.filesDocStageHelperService","teamspace.services.files.modules.sharePoint.filesSharingHelper","teamspace.files.fileViewErrorCodeSanitizerService"]).component("fileOfficeFrame",{bindings:{serviceName:"<",fileType:"<",objectUrl:"<",baseUrl:"<",fileId:"=",threadId:"<?",onTitleBarClosed:"&?",scenarioName:"<",userClickTime:"<",shareUrl:"<",shareId:"<"},template:r,controller:n})},2755:function(e,t){e.exports='<div id="file-office-frame" class="flex-fill">\n\n  \x3c!-- busy animation --\x3e\n  <busy-animation size="medium" ng-if="!($ctrl.fileDetail || ($ctrl.useOneUp && $ctrl.oneUpParams && !$ctrl.wacEdit)) && !$ctrl.fileErrorCode && !$ctrl.useNStarViewerExpInMainWindow" context="file-office-frame">\n  </busy-animation>\n\n  <file-document-title-bar id="ts-file-document-title-bar" ng-show="$ctrl.displayTitleBar || $ctrl.fileErrorCode" is-edit-mode="$ctrl.wacEdit" display-title-bar="$ctrl.displayTitleBar" edit-action="$ctrl.editAction" file-name="::$ctrl.fileName" file-type="::$ctrl.fileType" file-id="::$ctrl.fileId" hide-close="::!$ctrl.onTitleBarClosed" on-close="::$ctrl.onTitleBarClosed()" is-enabled="true" primary-options="::$ctrl.titleBarPrimaryOptions" more-options="::$ctrl.titleBarMoreOptions" move-edit-in-browser-from-more-options="$ctrl.moveEditInBrowserFromMoreOptions" error="$ctrl.fileErrorCode" error-reason-for-telemetry="$ctrl.errorReasonForTelemetry" conversation-info="::$ctrl.titleBarConversationInfo" viewer-type="::$ctrl.viewerType">\n  </file-document-title-bar>\n\n  <file-full-alert class="flex-fill" error="$ctrl.fileErrorCode" ng-if="$ctrl.fileErrorCode" object-url="{{$ctrl.objectUrl}}" share-url="{{$ctrl.shareUrl}}">\n  </file-full-alert>\n\n  <div class="office-frame flex-fill" ng-if="!$ctrl.fileErrorCode">\n    <div tabindex="0" set-focus="true" id="file-office-frame-container" acc-role="tab-handler-document-viewer-frame" role="application" class="flex-fill office-viewer-container" aria-label="{{::$ctrl.getAccessibleIframeNotice()}}" ng-if="::$ctrl.isPreProcessingComplete && !$ctrl.useNStarViewerExpInMainWindow && $ctrl.isRenderListApiCallComplete" ng-keydown="$ctrl.openInNewTab($event)">\n      <file-office-viewer ng-if="$ctrl.fileDetail && ($ctrl.wacEdit || !$ctrl.useOneUp)" type="::$ctrl.fileDetail.type" scenario="$ctrl.scenario" wac-url-source="$ctrl.wacUrl" wac-edit="$ctrl.wacEdit" ctx="::$ctrl.ctx" file-type="::$ctrl.fileType" class="flex-fill">\n      </file-office-viewer>\n      <file-one-up-viewer ng-if="$ctrl.oneUpParams && !$ctrl.wacEdit" type="::$ctrl.oneUpParams.fileType" scenario="$ctrl.oneUpParams.scenario" site-url="$ctrl.oneUpParams.baseUrl" server-relative-url="$ctrl.oneUpParams.serverRelativeUrl" file-detail="::$ctrl.oneUpParams.fileDetail" object-url="::$ctrl.objectUrl" service-name="::$ctrl.oneUpParams.serviceName" drive-item="$ctrl.driveItem" file-id="::$ctrl.fileId" class="flex-fill" page-context-info="$ctrl.pageContextInfo">\n\n      </file-one-up-viewer>\n    </div>\n\n    <div tabindex="0" set-focus="true" id="file-office-frame-experience-container" class="flex-fill office-viewer-container" role="application" aria-label="{{::$ctrl.getAccessibleIframeNotice()}}" ng-if="$ctrl.useNStarViewerExpInMainWindow" ng-keydown="$ctrl.openInNewTab($event)">\n      <div id="ts-unified-app-loader" ng-if="$ctrl.showSpinner">\n        <busy-animation size="medium" context="file-unified-app-viewer">\n        </busy-animation>\n      </div>\n      \x3c!-- ng-show ensures that files experience is not visible till redeem call succeeds.--\x3e\n      <file-unified-app-viewer ng-show="::$ctrl.isPreProcessingComplete" is-edit-mode="$ctrl.wacEdit" file-type="::$ctrl.fileType" object-url="::$ctrl.objectUrl" user-click-time="::$ctrl.userClickTime" scenario="::$ctrl.scenario" ctx="::$ctrl.ctx" drive-item-call-start-time="::$ctrl.driveItemCallStartTime" class="flex-fill file-unified-app-viewer-container" redeem-promise="$ctrl.redeemPromise" hide-spinner="$ctrl.hideSpinner" display-title-bar="$ctrl.displayTitleBar" more-options="::$ctrl.titleBarMoreOptions" hide-close="::!$ctrl.onTitleBarClosed" on-close="::$ctrl.onTitleBarClosed()" file-name="::$ctrl.fileName" thread-id="::$ctrl.threadId" service-name="::$ctrl.serviceName" move-edit-in-browser-from-more-options="$ctrl.moveEditInBrowserFromMoreOptions" file-id="::$ctrl.fileId">\n      </file-unified-app-viewer>\n    </div>\n  </div>\n</div>'},2756:function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var s=i(2757),r=function(){function e(e,t,i,s,r,n,o,a,l,c){var d=this;this.$scope=e,this.$sce=t,this.$window=i,this.$location=s,this.$timeout=r,this.constants=n,this.utilityService=a,this.desktopUtilityService=l,this.filesUtilityService=c,this.initialActiveElement=document.getElementById("file-office-frame-container")||window,this.isOneNote=n.fileExtensions.onenote.indexOf(this.type)>=0,this.isVisio=n.fileExtensions.visio.indexOf(this.type)>=0,this.isElectronApp=l.isElectron(),this.useHwaWebView=l.isHwa()&&o.valueAsBoolean(n.settings.names.enableMsWebViewFileOfficeViewer),this.useElectronWebView=this.isElectronApp;var h=i.electronSafeIpc;this.useHwaWebView?(this.init(),this._stopFullScreenScenario()):h&&this.useElectronWebView?(h.send(n.events.desktopApp.allowWebViewCreate),h.once(n.events.desktopApp.webViewCreationEnabled,function(e,t){d.webviewInstanceId=t,d.init(),d._stopFullScreenScenario(),d.isWebViewCreationEnabled=!0})):(this.init(),this._registerScenarioEnd()),this._ensureInitialFocusIsNotStolen()}return e.$inject=["$scope","$sce","$window","$location","$timeout","constants","settingsService","utilityService","desktopUtilityService","filesUtilityService"],e.prototype.$onChanges=function(e){var t=this;if(e.wacUrlSource&&!e.wacUrlSource.isFirstChange()){var i=this.$window.electronSafeIpc;i&&this.useElectronWebView&&this.isWebViewCreationEnabled||this.useHwaWebView?(this.init(),this._stopFullScreenScenario()):i&&this.useElectronWebView||(this.wacUrl=null,this.$timeout(function(){return t.init()},0,!1),this._registerScenarioEnd())}},e.prototype.init=function(){var e=this,t=this.wacUrlSource+"&hh=1",i=t.match(/sc=pmo[^&]*/g);t=t.replace(/sc=.*?&/g,""),this.wacEdit?t+="&sc=OwaEdit":i&&i.length&&(t=t+"&"+i[0]),t+="&uih=Teams";var s=this.filesUtilityService.isNStarViewerExpInMainWindowEnabled(this.fileType);t=this.ctx===this.constants.scenarios.files.newFileCreationContext&&s?t+"&uiEmbed=1":t;var r=this.utilityService.parseUrl(t);if(this.wacOrigin=r&&r.origin,this.wacUrl=this.$sce.trustAsResourceUrl(t),this.sourceElement=document.getElementsByClassName("wopi-iframe")[0],this.sourceElement){this.isElectronApp&&this.desktopUtilityService.stampWebviewInstanceIdInWebPreferences(this.sourceElement,this.webviewInstanceId);var n=this.layout.bind(this);this.sourceElement.addEventListener("dom-ready",n),this.$window.addEventListener("resize",n),this.$scope.$on("$destroy",function(){e.sourceElement.removeEventListener("dom-ready",n),e.$window.removeEventListener("resize",n)})}},e.prototype.layout=function(){if(this.sourceElement&&this.$window.electronSafeIpc){this.uuid||(this.uuid=this.utilityService.generateUUID());var e=this.sourceElement.clientWidth,t=this.sourceElement.clientHeight;this.$window.electronSafeIpc.send(this.constants.events.desktopApp.webViewResize,{width:e,height:t,uuid:this.uuid})}},e.prototype._registerScenarioEnd=function(){var e=this,t=this.$location.host();if(!(!this.useElectronWebView&&(t.endsWith(this.constants.counters.skype.skypeDomain)||t.endsWith(this.constants.counters.microsoft.domain)))||this.isOneNote||this.isVisio||this.wacEdit)this._stopFullScreenScenario();else{var i=angular.element(this.$window);this._onPostMessageReceive&&(i.unbind("message",this._onPostMessageReceive),this._onPostMessageReceiveDestroyHandler()),this._onPostMessageReceive=function(t){return e._postMessageReceiveHandler(t)},i.on("message",this._onPostMessageReceive),this._onPostMessageReceiveDestroyHandler=this.$scope.$on("$destroy",function(){i.unbind("message",e._onPostMessageReceive)})}},e.prototype._postMessageReceiveHandler=function(e){var t=e.originalEvent||e;if(t&&t.origin&&t.origin===this.wacOrigin){var i=JSON.parse(t.data||"{}");i.MessageId&&i.MessageId.toLowerCase()==="App_LoadingStatus".toLowerCase()&&(this._stopFullScreenScenario("wac"),angular.element(this.$window).unbind("message",this._onPostMessageReceive),this._onPostMessageReceiveDestroyHandler(),this._onPostMessageReceive=null)}},e.prototype._stopFullScreenScenario=function(e){void 0===e&&(e=""),this.scenario&&this.scenario.stop({context:e})},e.prototype._ensureInitialFocusIsNotStolen=function(){var e=this;this.focusCounter=0;var t=angular.element(this.$window);this._onWindowBlur&&(t.unbind(this.constants.events.jQuery.blur,this._onWindowBlur),this._onWindowBlurDestroyHandler()),this._onWindowBlur=function(t){return e._onWindowBlurHandler(t)},t.on(this.constants.events.jQuery.blur,this._onWindowBlur),this._onWindowBlurDestroyHandler=this.$scope.$on("$destroy",function(){t.unbind(e.constants.events.jQuery.blur,e._onWindowBlur)})},e.prototype._onWindowBlurHandler=function(e){var t=this;this.focusCounter++;var i=this.isOneNote?2:1;this.focusCounter==i&&(angular.element(this.$window).unbind(this.constants.events.jQuery.blur,this._onWindowBlur),this._onWindowBlurDestroyHandler(),this._onWindowBlur=null),this.$timeout(function(){return angular.element(t.initialActiveElement).focus()},100,!1)},e}();angular.module("teamspace.fileOfficeViewer",["teamspace.settingsService","teamspace.filesUtilityService","teamspace.desktopUtilityService"]).component("fileOfficeViewer",{bindings:{type:"<",scenario:"<",wacEdit:"<",wacUrlSource:"<",ctx:"<",fileType:"<"},template:s,controller:r})},2757:function(e,t){e.exports='<div id="file-office-viewer" class="flex-fill">\n\n  <iframe ng-if="$ctrl.wacUrl && !($ctrl.useElectronWebView || $ctrl.useHwaWebView)" ng-src="{{$ctrl.wacUrl}}" ng-attr-sandbox="{{ ::$ctrl.isElectronApp ? \'allow-forms allow-popups allow-pointer-lock allow-same-origin allow-scripts\' : undefined }}" class="wopi-iframe flex-fill" frameborder="0" role="presentation" tabindex="-1" aria-hidden="true">\n  </iframe>\n\n  <webview ng-if="::$ctrl.useElectronWebView && !$ctrl.useHwaWebView" ng-src="{{$ctrl.wacUrl}}" class="wopi-iframe flex-fill" frameborder="0" role="presentation" tabindex="-1" aria-hidden="true" webpreferences="nativeWindowOpen=yes" allowpopups="">\n  </webview>\n\n  \x3c!-- TODO tac: use embedded-page-container instead once it supports url updates --\x3e\n  <x-ms-webview ng-if="::$ctrl.useHwaWebView" ng-src="{{$ctrl.wacUrl}}" class="wopi-iframe flex-fill" frameborder="0" role="presentation" tabindex="-1" aria-hidden="true">\n  </x-ms-webview>\n</div>\n'}},[2744]);
//# sourceMappingURL=[[staticsPath]]/hashed/lazy-ng1-mod-files-components.min-769f0cb.js.map