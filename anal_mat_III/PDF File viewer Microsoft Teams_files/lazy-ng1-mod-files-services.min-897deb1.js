webpackJsonp([31],{2764:function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),i(2765),i(2766),i(2767),i(2768)},2765:function(e,t,i){"use strict";var s=this&&this.__extends||function(){var e=function(t,i){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])})(t,i)};return function(t,i){function s(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(s.prototype=i.prototype,new s)}}();Object.defineProperty(t,"__esModule",{value:!0});var r=teamspace.services.files,n=function(e){function t(t,i,s,r,n,o,a){var c=e.call(this,o)||this;return c.recentFilesClientCache=t,c.directoryItemEntityColumnMappers=i,c.simpleFileEntityFactory=s,c.filesProviderFactory=r,c.constants=n,c.orchestrationService=o,c.simpleMTFilesRepositoryFactory=a,c.initializeOnAppLaunchAndReinit(),c}return s(t,e),t.$inject=["recentFilesClientCache","directoryItemEntityColumnMappers","simpleFileEntityFactory","filesProviderFactory","constants","orchestrationService","simpleMTFilesRepositoryFactory"],t.prototype.initializeOnAppLaunchAndReinit=function(e){var t=this.constants.urls.files.service.recent.getFiles.get+"?"+this.constants.files.strings.params.recentFiles,i={callType:this.constants.urls.files.service.recent.getFiles.type};this.store=this.simpleMTFilesRepositoryFactory.create(t,i,r.FilesProviderType.Recent,this.recentFilesClientCache);var s=this.filesProviderFactory.create(r.FilesProviderType.Recent);this.filesEntityContext={serviceName:"recent",provider:s}},t.prototype.cleanupOnAppTeardown=function(e){this.store=void 0,this.filesEntityContext=void 0},t.prototype.mtmaTelemetryIdentifier=function(){return"RecentFilesServiceImplementation"},t.prototype.getRecentFilesWithName=function(e){var t=this;return this.store.getItems(!1).then(function(i){var s=i.value;if(_.isUndefined(s)||_.isEmpty(s))return[];var r=_.filter(s,function(t){return _.includes(t.title.toLowerCase(),e.toLowerCase())});return _.map(r,function(e){return{simpleFileDto:e,iconData:t.populateIconData(e),dateData:t.populateLastModifiedData(e),title:e.title}})})},t.prototype.getRoute=function(e,t){if(e){var i=this.simpleFileEntityFactory.create(e,this.filesEntityContext);return this.filesEntityContext.provider.contructViewerRoute(i,this.filesEntityContext,this.constants.files.fileActions.viewer.view,t||"recent")}},t.prototype.isIconImage=function(e){return e&&!e.isSvg},t.prototype.getProviderIconPath=function(e){return e&&e.defaultIconPath},t.prototype.getProviderIconAltText=function(e){return e&&e.altTextResourceKey},t.prototype.populateIconData=function(e){var t=this.simpleFileEntityFactory.create(e,this.filesEntityContext),i=this.directoryItemEntityColumnMappers.iconColumn(teamspace.components.files.FileIconSize.S32,this.filesEntityContext.provider,!0);if(i){var s=i.getSVGIconContext(t),r=s.svgClass,n=s.svgPath,o=s.svgTitle,a=i.getProviderIcon?i.getProviderIcon(t):void 0,c=i.getExternalImageContext(t);return{svgClass:r,svgPath:n,svgTitle:o,imgSrc:c.imgSrc,title:c.title,isIconImage:this.isIconImage(a),providerIconAltText:this.getProviderIconAltText(a),providerIconPath:this.getProviderIconPath(a)}}},t.prototype.populateLastModifiedData=function(e){var t=this.simpleFileEntityFactory.create(e,this.filesEntityContext),i=this.directoryItemEntityColumnMappers.lastModifiedColumn().getTimeAgoContext(t);return{useTimeAgo:i.useTimeAgo,lastModifiedTime:i.lastModifiedTime,localDate:i.localDate,displayDate:i.displayDate}},t}(teamspace.services.MTMABase);t.RecentFilesServiceImplementation=n,angular.module("teamspace.recentFilesService",["teamspace.constants","teamspace.services.files.modules.simple.simpleMTFilesRepositoryFactory"]).service("recentFilesService",n)},2766:function(e,t,i){"use strict";var s=function(){function e(e,t,i,s,r,n,o,a,c,l,f){this.$q=e,this.$translate=t,this.constants=i,this.filesUtilityService=s,this.resources=r,this.utilityService=n,this.routeUtilityService=o,this.uploadActions=a,this.filesProviderFactory=c,this.personalFilesDetailsService=l,this.settingsService=f}return e.$inject=["$q","$translate","constants","filesUtilityService","resources","utilityService","routeUtilityService","uploadActions","filesProviderFactory","personalFilesDetailsService","settingsService"],e.prototype.shareExistingFile=function(e,t){t||this.$q.reject("Invalid parameter"),e&&e.containerId||this.$q.reject("ContainerId not provided on context");var i=this.routeUtilityService.getRootRouteParams(),s=!!i&&(i.middlePane===this.constants.messages.panes.conversations||!!e.messagePaneAvailable);return this.uploadActions.shareExistingFile({conversationId:e.containerId,isConversation:s,messageBody:e.messageBody,serviceName:e.serviceName,sourceProvider:this.filesProviderFactory.create(teamspace.services.files.FilesProviderType.Sharepoint),destinationProvider:this.filesProviderFactory.create(teamspace.services.files.FilesProviderType.Sharepoint),viewId:s?e.draftClientId:e.containerId,upload:{objectId:t.objectId,objectUrl:t.objectUrl,serverRelativeUrl:t.serverRelativeUrl,serviceName:e.serviceName,siteUrl:t.siteUrl,state:this.constants.files.fileChiclet.states.reference,thumbnail:void 0,title:t.title,type:t.type,chicletBreadcrumbs:t.chicletBreadcrumbs,sourceOfFile:t.sourceOfFile}}),this.$q.resolve()},e.prototype.upload=function(e,t,i,s,r,n){var o=this.personalFilesDetailsService.getPersonalSiteInfo(),a=o&&o.personalRootFolderUrl?this.utilityService.combineUriComponents(o.personalRootFolderUrl,this.$translate.instant(this.resources.strings.files_chatFileShareFolder)):"";this.uploadActions.uploadFile({serviceName:this.constants.files.serviceName.p2p,channelId:t,viewId:i,contents:_.map(e,function(e){return{file:e,fileName:e.name}}),overWrite:!1,serverRelativeUrl:this.filesUtilityService.extractServerRelativeUrl(a),messageBody:n,isPostedInConversation:s,generateThumbNail:r,telemetry:{source:"chat-files",entryPoint:"chat-files",scenarioName:this.getUploadScenarioName(s)},sourceProvider:this.filesProviderFactory.create(teamspace.services.files.FilesProviderType.Sharepoint),destinationProvider:this.filesProviderFactory.create(teamspace.services.files.FilesProviderType.Sharepoint),sourceOfFile:teamspace.services.files.modules.fileUpload.SourceOfFile.UploadFromPc})},e.prototype.getUploadScenarioName=function(e){return e?this.isV3UploadTelemetryEnabled()?this.constants.scenarios.files.uploadFileInChatTab:this.constants.scenarios.files.uploadAndShareFile.scenarioName:""},e.prototype.isV3UploadTelemetryEnabled=function(){return this.settingsService.valueAsBoolean(this.constants.settings.names.enableV3FileUploadTelemetry)},e}();angular.module("teamspace.chatFilesShareService",["teamspace.qAllSettled","teamspace.utilityService","teamspace.routeUtilityService","skypeX.myUserPreferencesStore","teamspace.filesEntityService","teamspace.filesUtilityService","teamspace.services.actions.files.uploadActions","teamspace.services.files.filesProviderFactory","teamspace.personalFilesDetailsService","teamspace.settingsService"]).service("chatFilesShareService",s)},2767:function(e,t,i){"use strict";var s=this&&this.__extends||function(){var e=function(t,i){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])})(t,i)};return function(t,i){function s(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(s.prototype=i.prototype,new s)}}(),r=function(e){function t(i,s,r,n,o,a,c,l,f,p){var h=e.call(this,l)||this;return h.resourceManager=i,h.channelService=s,h.constants=r,h.loggingService=n,h.sharePointRepositoryDirect=o,h.filesProviderFactory=a,h.$injector=c,h.orchestrationService=l,h.filesUtilityService=f,h.settingsService=p,h.PREFETCH_TTL_IN_MINUTES=30,h.PREFETCH_LOG={},h.NUMBER_OF_ITEMS=25,h.logger=n.newLogger(t.className),h.initializeOnAppLaunchAndReinit("First initialize"),h}return s(t,e),t.$inject=["resourceManager","channelService","constants","loggingService","sharePointRepositoryDirect","filesProviderFactory","$injector","orchestrationService","filesUtilityService","settingsService"],t.prototype.initializeOnAppLaunchAndReinit=function(e){},t.prototype.cleanupOnAppTeardown=function(e){this.PREFETCH_LOG={}},t.prototype.mtmaTelemetryIdentifier=function(){return t.className},t.prototype.initializeFilesPrefetcher=function(e,t,i){return this.$injector.get("bridgeFilesPrefetchService").initialize(e,t,i)},t.prototype.prefetchSharepointData=function(e,t){return this.$injector.get("bridgeFilesPrefetchService").prefetchSharepointData(e,t)},t.prototype.pruneData=function(e){this.$injector.get("bridgeFilesPrefetchService").pruneData(e)},t.prototype.prefetchFilesForChannel=function(e){var t=this;if(this.settingsService.valueAsBoolean(this.constants.settings.names.enableChannelFilesPrefetch)){var i,s,r,n=this.settingsService.valueAsBoolean(this.constants.settings.names.enableChannelFilesViewsBridge),o=this.loggingService.newScenario(n?this.constants.scenarios.files.prefetchChannelFilesV2.scenarioName:this.constants.scenarios.files.prefetchChannelFiles.scenarioName),a=this.channelService.getChannelByObjectId(e);if(!a)return this.logger.warn("Could not find channel for channelId ["+e+"]"),void o.incomplete({reason:this.constants.scenarios.files.prefetchChannelFiles.reasons.missingTeamChannelInfo});if(!(s=this.filesUtilityService.getSiteUrlForChannel(e)))return this.logger.warn("siteUrl doesn't exist for ["+e+"]"),void o.incomplete({reason:this.constants.scenarios.files.prefetchChannelFiles.reasons.missingTeamChannelInfo});if(!a.folderRelativeUrl)return this.logger.warn("TeamChannelTuple does not contain channel or channel.folderRelativeUrl for channelId ["+e+"]"),void o.incomplete({reason:this.constants.scenarios.files.prefetchChannelFiles.reasons.missingTeamChannelInfo});if(r=a.folderRelativeUrl,n)this.prefetchForChannelFilesOverBridge(a,s,r,o);else{if(!a.documentLibraryId)return this.logger.warn("TeamChannelTuple does not contain channel or channel.documentLibraryId for channelId ["+e+"]"),void o.incomplete({reason:this.constants.scenarios.files.prefetchChannelFiles.reasons.missingTeamChannelInfo});i=a.documentLibraryId,this.isTtlExpired(s)?(this.PREFETCH_LOG[s]=moment(),this.resourceManager.scheduleTask({priority:teamspace.services.TaskPriority.Background,type:this.constants.tasks.conversationSwitch,tag:"files-prefetch",task:function(){o.mark(t.constants.scenarios.files.prefetchChannelFiles.marks.taskStarted);var n={threadId:e,siteUrl:s,serverRelativeRootUrl:r,rootRelativeFolderUrl:void 0,sortedAscending:!1,pageSize:t.constants.files.parameters.sharePointFilesPageSize,libraryId:i,libraryTitle:t.constants.files.strings.defaultDocumentTitle,serviceName:t.constants.files.serviceName.teams,provider:t.filesProviderFactory.create(teamspace.services.files.FilesProviderType.Sharepoint)};return t.sharePointRepositoryDirect.getItems(n,"",t.NUMBER_OF_ITEMS,!0).then(function(){return o.stop()},function(){return o.fail({reason:t.constants.scenarios.files.prefetchChannelFiles.reasons.spApiError})})}}),o.mark(this.constants.scenarios.files.prefetchChannelFiles.marks.taskScheduled)):o.incomplete({reason:this.constants.scenarios.files.prefetchChannelFiles.reasons.throttled})}}},t.prototype.prefetchForChannelFilesOverBridge=function(e,t,i,s){var r=this.$injector.get("bridgeFilesPrefetchService");if(!e.isFavorite)return this.logger.warn("Channel is not favourite"),void s.incomplete({reason:this.constants.scenarios.files.prefetchChannelFilesV2.reasons.channelNotFavorite});r.prefetchChannelFiles(t,i,s).catch(function(e){s.fail(e)})},t.prototype.isTtlExpired=function(e){return!!_.isUndefined(this.PREFETCH_LOG[e])||moment().isAfter(moment(this.PREFETCH_LOG[e]).add(this.PREFETCH_TTL_IN_MINUTES,"m"))},t.className="FilesPrefetchService",t}(teamspace.services.MTMABase);angular.module("teamspace.filesPrefetchService",["teamspace.resourceManager","teamspace.services.files.modules.sharePoint.documentLibraryClient","teamspace.constants","teamspace.services.files.modules.sharePoint.sharePointRepositoryDirect","teamspace.services.files.filesProviderFactory"]).service("filesPrefetchService",r)},2768:function(e,t,i){"use strict";var s=function(){function e(e,t,i,s,r,n,o){var a=this;this.resources=e,this.constants=t,this.dialogService=i,this.freemiumUtilities=s,this.$translate=r,this.notificationsService=n,this.handleRequestError=function(e,t){if(!e||!e.response||!e.response.errorCode)return!1;if(e.status<400||e.status>500)return!1;var i=a.$translate.instant(a.resources.strings.files_fileActionErrorTitle),s="",r="";if(a.showSpQuotaExceededErrorDialogIfNeeded(e,!1))a.logger.warn("File error: "+a.$translate.instant(a.resources.strings.files_fileUploadFailedQuotaExceeded));else{switch(e.response.errorCode){case a.constants.files.error.channelDoesNotExist:r=s="Please fix this channel as it is missing the channel folder.";break;case a.constants.files.error.filenameCollision:break;case a.constants.files.error.folderDoesNotExist:r=s="We are trying to create file in non existent folder.";break;case a.constants.files.error.resourceLocked:case a.constants.files.error.fileLocked:r=a.$translate.instant(a.resources.strings.files_fileLockedError,{filename:"filename"}),s=a.$translate.instant(a.resources.strings.files_fileLockedError,{filename:t.title});break;case a.constants.files.error.resourceDoesNotExist:i=a.$translate.instant(a.resources.strings.files_fileUploadFailed);case a.constants.files.error.fileDoesNotExist:r=s=a.$translate.instant(a.resources.strings.files_fileFileDoesNotExist);break;case a.constants.files.error.fileInvalidCharacters:case a.constants.files.error.invalidCharacters:r=s=a.$translate.instant(a.resources.strings.files_fileInvalidCharsError);break;case a.constants.files.error.maxLengthExceeded:case a.constants.files.error.requestTimeout:case a.constants.files.error.resourceAlreadyExists:case a.constants.files.error.unauthorized:default:a.logger.info("Unexpected error: "+e.response.errorCode)}if(s.length>0&&(a.logger.error(r),!t.disableSystemNotifications)){var n={title:i,iconName:"icons-files-missing",message:s,timeout:!0,type:"ts-toast-chat alert"};a.notificationsService.createNotification(n,function(){})}}return!0},this.handleSystemError=function(e,t,i){if(!e||!e.errorCode)return!1;if(t<500||t>=600)return!1;var s="";switch(e.errorCode){case a.constants.files.error.requestDidNotComplete:case a.constants.files.error.mtSiteIsNotAvailable:case a.constants.files.error.spNotAvailable:case a.constants.files.error.spThrottled:case a.constants.files.error.spSiteDoesNotExist:s=a.$translate.instant(a.resources.strings.files_fileServiceError);break;case a.constants.files.error.spQuotaExceeded:s=a.$translate.instant(a.resources.strings.files_fileQuotaExceededError);break;default:a.logger.info("Unexpected error: "+e.errorCode)}if(s.length>0&&(a.logger.error(s),!i.disableSystemNotifications)){var r={title:a.$translate.instant(a.resources.strings.files_fileActionErrorTitle),iconName:"icons-error",message:s,timeout:!1,type:"ts-toast-chat alert"};a.notificationsService.createNotification(r,function(){})}return!0},this.showSpQuotaExceededErrorDialogIfNeeded=function(e,t){void 0===t&&(t=!0);var i=!1;return e&&e.response&&(i=(i=e.response.errorCode===a.constants.files.error.spQuotaExceeded)||e.message&&e.message.contains(a.constants.files.upload.spQuotaExceeded))&&t&&a.freemiumUtilities.loadModule().then(function(){return a.dialogService.open(a.constants.dialogs.freemiumStorageExceededDialog)}),i},this.logger=o.newLogger("FilesErrorHandler")}return e.$inject=["resources","constants","dialogService","freemiumUtilities","$translate","notificationsService","loggingService"],e}();angular.module("teamspace.filesErrorHandler",["teamspace.notificationsService","teamspace.constants","teamspace.freemiumUtilities","teamspace.loggingService","pascalprecht.translate","teamspace.dialogService"]).service("filesErrorHandler",s)}},[2764]);
//# sourceMappingURL=[[staticsPath]]/hashed/lazy-ng1-mod-files-services.min-051ff6d.js.map