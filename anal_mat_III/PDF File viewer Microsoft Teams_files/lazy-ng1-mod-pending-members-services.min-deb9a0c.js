webpackJsonp([67],{2769:function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),t(2770)},2770:function(e,n,t){"use strict";var s=this&&this.__extends||function(){var e=function(n,t){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,n){e.__proto__=n}||function(e,n){for(var t in n)n.hasOwnProperty(t)&&(e[t]=n[t])})(n,t)};return function(n,t){function s(){this.constructor=n}e(n,t),n.prototype=null===t?Object.create(t):(s.prototype=t.prototype,new s)}}(),r=this&&this.__awaiter||function(e,n,t,s){function r(e){return e instanceof t?e:new t(function(n){n(e)})}return new(t||(t=Promise))(function(t,a){function i(e){try{c(s.next(e))}catch(e){a(e)}}function o(e){try{c(s.throw(e))}catch(e){a(e)}}function c(e){e.done?t(e.value):r(e.value).then(i,o)}c((s=s.apply(e,n||[])).next())})},a=this&&this.__generator||function(e,n){function t(e){return function(n){return s([e,n])}}function s(t){if(r)throw new TypeError("Generator is already executing.");for(;c;)try{if(r=1,a&&(i=2&t[0]?a.return:t[0]?a.throw||((i=a.return)&&i.call(a),0):a.next)&&!(i=i.call(a,t[1])).done)return i;switch(a=0,i&&(t=[2&t[0],i.value]),t[0]){case 0:case 1:i=t;break;case 4:return c.label++,{value:t[1],done:!1};case 5:c.label++,a=t[1],t=[0];continue;case 7:t=c.ops.pop(),c.trys.pop();continue;default:if(i=c.trys,!(i=i.length>0&&i[i.length-1])&&(6===t[0]||2===t[0])){c=0;continue}if(3===t[0]&&(!i||t[1]>i[0]&&t[1]<i[3])){c.label=t[1];break}if(6===t[0]&&c.label<i[1]){c.label=i[1],i=t;break}if(i&&c.label<i[2]){c.label=i[2],c.ops.push(t);break}i[2]&&c.ops.pop(),c.trys.pop();continue}t=n.call(e,c)}catch(e){t=[6,e],a=0}finally{r=i=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}var r,a,i,o,c={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:t(0),throw:t(1),return:t(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o};Object.defineProperty(n,"__esModule",{value:!0});var i=function(e){function n(n,t,s,r,a,i,o,c,p,m,l,d,u,h){var b=e.call(this,u)||this;return b.$translate=n,b.resources=t,b.appStateAdapter=s,b.loggingService=r,b.channelService=a,b.teamMembershipService=i,b.constants=o,b.teamMembershipPropertiesService=c,b.dialogService=p,b.conversationsService=m,b.teamsAndChannelsRestClient=l,b.$state=d,b.enablePendingMembersActivateV2=h.valueAsBoolean(o.settings.names.enablePendingMembersActivateV2),b.logger=r.newLogger("pendingMembersService"),b.initializeOnAppLaunchAndReinit("firstLaunch"),b}return s(n,e),n.$inject=["$translate","resources","appStateAdapter","loggingService","channelService","teamMembershipService","constants","teamMembershipPropertiesService","dialogService","conversationsService","teamsAndChannelsRestClient","$state","orchestrationService","settingsService"],n.prototype.initializeOnAppLaunchAndReinit=function(e){this.banner=null},n.prototype.cleanupOnAppTeardown=function(e){this.banner=void 0,this.threadUpdateToken=void 0,this.cachedIsUnlockMembershipSyncRequired=void 0,this.cachedIsTeamLocked=void 0},n.prototype.mtmaTelemetryIdentifier=function(){return"PendingMembersService"},n.prototype.showPendingMembersBannerIfNeeded=function(e){return r(this,void 0,void 0,function(){var n,t,s,r,i,o,c;return a(this,function(a){switch(a.label){case 0:if(this.banner&&this.hidePendingMembersBanner(),n=this.channelService.getTeamByObjectId(e),!this.isAdminRole(n))return[2];if(!this.isClassTeam(n))return[2];if(null===n||void 0===n?void 0:n.isArchived)return[2];if(t=this.isTeamLocked(n),this.cachedIsTeamLocked=t,this.enablePendingMembersActivateV2){if(s=this.isUnlockMembershipSyncRequired(n),this.cachedIsUnlockMembershipSyncRequired=s,!t&&!s)return[2]}else if(!t)return[2];return r=new teamspace.services.BannerOptions,[4,this.getBannerString(t,e)];case 1:return i=a.sent(),this.banner&&this.hidePendingMembersBanner(),o=this.channelService.getParentTeamAndChannelByChannelId(this.$state.params.threadId),(c=o&&o.channel&&o.channel.parentTeamId)!==e?[2]:(t?this.setLockedTeamBannerOptions(r):this.setPendingMembersBannerOptions(r,e),r.hideAction=function(){angular.element($(".app-notification-banner")).removeClass(r.cssClass)},r.telemetryOptions={panelRegion:teamspace.PanelRegion.banner,panelType:teamspace.PanelType.pendingMembersBanner,moduleName:teamspace.components.PanelModuleName.pendingMembersBanner,moduleType:teamspace.components.PanelModuleType.pendingMembersBanner,closeGesture:teamspace.components.PanelActionGesture.click,closeModuleType:teamspace.components.PanelModuleType.button,closeScenario:teamspace.components.PanelActionScenario.pendingMembersBannerActivateButton,scenario:teamspace.components.PanelActionScenario.pendingMembersBanner,scenarioType:teamspace.components.PanelActionScenarioType.Tms_Conv_PendingMembersActivateBanner,closeOutcome:teamspace.components.PanelActionOutcome.dismiss,closeModuleSummary:"close pending members banner"},this.banner=this.appStateAdapter.mainNotificationBannerStore.showBanner(teamspace.services.Severity.PendingMembers,i,this.constants.banners.pendingMembers.name,r),angular.element($(".app-notification-banner")).addClass(r.cssClass),this.logger.log("Displaying pending members banner."),this.subscribeToLongPollServices(e),[2])}})})},n.prototype.activateTeam=function(e){return r(this,void 0,void 0,function(){var n,t,s,r,i,o,c,p;return a(this,function(a){switch(a.label){case 0:if(!e)throw this.loggingService.error("TeamMembershipService: getPendingTeamMembers - Passed in Team object is Null"),Error("Passed Team Object is invalid");n=this.loggingService.newScenario(this.constants.scenarios.pendingMembers.unlockTeamRequest),t={teamId:e},s=this.constants.urls.teams.unlock.replace("{teamThreadId}",encodeURIComponent(e)),r={callType:this.constants.urls.members.type,counter:this.constants.scenarios.teamAndChannel.groupUpdate},a.label=1;case 1:return a.trys.push([1,3,,4]),[4,Promise.resolve(this.teamsAndChannelsRestClient.performApiPost(s,r,void 0))];case 2:if(!(i=a.sent()))throw Error("Invalid response data");if(!(o=i.value))throw Error("Invalid response data, missing 'value' property");if(!(c=o.status))throw Error("Invalid response data, missing 'status' property");switch(c){case"Success":return n.stop(t),this.showNetworkSuccessBanner(),[2,1];case"InProgress":return n.stop(t),this.showPendingMembersBannerIfNeeded(e),[2,0];case"Error":return this.enablePendingMembersActivateV2?(n.stop(t),this.showPendingMembersBannerIfNeeded(e),[2,3]):(t.errorMessage="API response status is Error",n.fail(t),[2,2]);default:throw Error("Invalid response data, invalid 'status'")}return[3,4];case 3:return p=a.sent(),this.showPendingMembersBannerIfNeeded(e),t.errorMessage=this.getErrorMessage(p),n.fail(t),this.logger.error("Error activate team: "+p+"."),[2,2];case 4:return[2]}})})},n.prototype.hidePendingMembersBanner=function(){this.banner&&this.banner.hide(),this.banner&&this.unsubscribeToLongPollServices(),this.banner=null},n.prototype.showNetworkInProgressBanner=function(){if(this.enablePendingMembersActivateV2){this.banner&&this.banner.hide();var e=new teamspace.services.BannerOptions;e.telemetryOptions={panelRegion:teamspace.PanelRegion.banner,panelType:teamspace.PanelType.pendingMembersBanner,moduleName:teamspace.components.PanelModuleName.pendingMembersBanner,moduleType:teamspace.components.PanelModuleType.pendingMembersBanner,closeGesture:teamspace.components.PanelActionGesture.click,closeModuleType:teamspace.components.PanelModuleType.button,closeScenario:teamspace.components.PanelActionScenario.pendingMembersBannerActivateButton,scenario:teamspace.components.PanelActionScenario.pendingMembersBanner,scenarioType:teamspace.components.PanelActionScenarioType.Tms_Conv_PendingMembersActivateBanner,closeOutcome:teamspace.components.PanelActionOutcome.dismiss,closeModuleSummary:"close pending members banner"},e.cssClass="pending-members-info";var n=this.$translate.instant(this.resources.strings.pending_members_banner_adding_members);this.banner=this.appStateAdapter.mainNotificationBannerStore.showBanner(teamspace.services.Severity.PendingMembers,n,this.constants.banners.pendingMembers.name,e)}},n.prototype.showNetworkSuccessBanner=function(){if(this.enablePendingMembersActivateV2){this.hidePendingMembersBanner();var e=new teamspace.services.BannerOptions;e.telemetryOptions={panelRegion:teamspace.PanelRegion.banner,panelType:teamspace.PanelType.pendingMembersBanner,moduleName:teamspace.components.PanelModuleName.pendingMembersBanner,moduleType:teamspace.components.PanelModuleType.pendingMembersBanner,closeGesture:teamspace.components.PanelActionGesture.click,closeModuleType:teamspace.components.PanelModuleType.button,closeScenario:teamspace.components.PanelActionScenario.pendingMembersBannerActivateButton,scenario:teamspace.components.PanelActionScenario.pendingMembersBanner,scenarioType:teamspace.components.PanelActionScenarioType.Tms_Conv_PendingMembersActivateBanner,closeOutcome:teamspace.components.PanelActionOutcome.dismiss,closeModuleSummary:"close pending members banner"},e.cssClass="pending-members-info";var n=this.$translate.instant(this.resources.strings.pending_members_banner_add_success);this.banner=this.appStateAdapter.mainNotificationBannerStore.showBanner(teamspace.services.Severity.PendingMembers,n,this.constants.banners.pendingMembers.name,e)}},n.prototype.subscribeToLongPollServices=function(e){var n=this;this.threadUpdateToken=teamspace.services.MTMASubscriptionUtility.subscribe(this.conversationsService,function(t,s){return n.handleBannerUpdate(s,e)},teamspace.services.ConversationsServiceEvents.EventType_Batched)},n.prototype.unsubscribeToLongPollServices=function(){teamspace.services.MTMASubscriptionUtility.unsubscribe(this.conversationsService,this.threadUpdateToken)},n.prototype.handleBannerUpdate=function(e,n){if(e)for(var t=0,s=e;t<s.length;t++){var r=s[t];r.getTeamId()===n&&this.applyThreadUpdate(r)}},n.prototype.applyThreadUpdate=function(e){var n="true"===e.threadProperties[SkypeX.Services.ChatServiceUtils.ThreadProp_IsTeamLocked],t="true"===e.threadProperties[SkypeX.Services.ChatServiceUtils.ThreadProp_IsUnlockMembershipSyncRequired],s=this.loggingService.newScenario(this.constants.scenarios.pendingMembers.bannerHiddenFromThreadUpdate),r={teamId:e.id};if(this.enablePendingMembersActivateV2)if(!0===n||!0===t){if(this.cachedIsTeamLocked!==n||this.cachedIsUnlockMembershipSyncRequired!==t){var a=e.getTeamId();this.showPendingMembersBannerIfNeeded(a)}}else this.unsubscribeToLongPollServices();else!1===n&&this.banner?this.hidePendingMembersBanner():this.banner||this.unsubscribeToLongPollServices();s.stop(r)},n.prototype.isAdminRole=function(e){return!!e&&this.teamMembershipPropertiesService.getRole(e.objectId)==this.constants.RoleConstants.Admin},n.prototype.isClassTeam=function(e){return!!e&&2==e.teamType},n.prototype.isTeamLocked=function(e){return!!e&&e.isTeamLocked},n.prototype.isUnlockMembershipSyncRequired=function(e){return e&&e.isUnlockMembershipSyncRequired},n.prototype.getNumberOfPendingMembers=function(e){var n=this,t=this.loggingService.newScenario(this.constants.scenarios.pendingMembers.getPendingMembersRequest),s={teamId:e};return this.teamMembershipService.getPendingTeamMembers(e).then(function(e){return t.stop(s),e.length},function(e){return s.error=e,t.fail(s),n.logger.log("Failed to fetch pending team members."),-1})},n.prototype.getBannerString=function(e,n){return r(this,void 0,void 0,function(){var t,s;return a(this,function(r){switch(r.label){case 0:return e?(t=this.$translate.instant(this.resources.strings.error_and_no_member_pending_members_banner),[4,this.getNumberOfPendingMembers(n)]):[3,2];case 1:return(s=r.sent())>0&&(t=this.$translate.instant(this.resources.strings.pending_members_banner_mf,{number:s},this.constants.translation.interpolationIds.messageformat)),[2,t];case 2:return[2,this.$translate.instant(this.resources.strings.pending_members_banner_add_error)]}})})},n.prototype.setLockedTeamBannerOptions=function(e){var n=this;e.action=new teamspace.services.BannerAction(this.$translate.instant(this.resources.strings.pending_members_activate_button),function(){n.dialogService.openLazyDialog(n.constants.lazyDialogs.pendingMembersActivateDialog,n.constants.lazyModules.pendingMembersActivateDialog)}),e.action.telemetryOptions={moduleName:teamspace.components.PanelModuleName.pendingMembersBannerActivateButton,moduleType:teamspace.components.PanelModuleType.button,scenario:teamspace.components.PanelActionScenario.pendingMembersBannerActivateButton,scenarioType:teamspace.components.PanelActionScenarioType.Tms_Conv_PendingMembersBannerActivateButton,moduleSummary:"Pending members banner button",gesture:teamspace.components.PanelActionGesture.click,outcome:teamspace.components.PanelActionOutcome.openDialog},e.cssClass="pending-members"},n.prototype.setPendingMembersBannerOptions=function(e,n){var t=this;e.action=new teamspace.services.BannerAction(this.$translate.instant(this.resources.strings.pending_members_retry_button),function(){t.showNetworkInProgressBanner(),t.activateTeam(n)}),e.action.telemetryOptions={moduleName:teamspace.components.PanelModuleName.pendingMembersBannerActivateButton,moduleType:teamspace.components.PanelModuleType.button,scenario:teamspace.components.PanelActionScenario.pendingMembersBannerActivateButton,scenarioType:teamspace.components.PanelActionScenarioType.Tms_Conv_PendingMembersBannerActivateButton,moduleSummary:"Pending members add members",gesture:teamspace.components.PanelActionGesture.click,outcome:teamspace.components.PanelActionOutcome.submit},e.cssClass="pending-members add-members"},n.prototype.getErrorMessage=function(e){if(void 0===e||null===e)return"The error is either null or undefined.";if("string"==typeof e)return e;var n;try{n=JSON.stringify(e)}catch(e){n="passing bad object to JSON.stringify. "+e.message,this.logger&&this.logger.error("passing bad object to JSON.stringify. "+e)}return n},n}(teamspace.services.MTMABase);n.PendingMembersService=i,angular.module("teamspace.pendingMembersService",["teamspace.appStateAdapter","teamspace.loggingService","teamspace.orchestrationService","teamspace.teamMembershipService"]).service("pendingMembersService",i)}},[2769]);
//# sourceMappingURL=[[staticsPath]]/hashed/lazy-ng1-mod-pending-members-services.min-1a8a5fc.js.map